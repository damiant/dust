import{a as ae}from"./chunk-YLPHNW7F.js";import{a as ie}from"./chunk-KCPLCCSF.js";import{a as ne}from"./chunk-5B2MUMUK.js";import{K as te}from"./chunk-5GFD3MFK.js";import"./chunk-PFLI22GG.js";import{$ as P,Aa as m,Ba as g,Ca as w,Db as D,Dc as Y,E as L,Ec as Z,Fc as ee,H as r,P as R,Ua as O,Wb as N,X as h,Y as _,Za as A,aa as U,ba as x,bc as j,ca as s,cc as Q,da as l,dc as W,ea as y,ja as T,la as F,lc as z,na as u,p as k,ra as V,rc as q,s as S,sa as B,sc as H,t as E,ta as $,tc as G,uc as J,vc as K,yc as X}from"./chunk-FDEJMFAU.js";import"./chunk-JORYF43P.js";import"./chunk-7KGURMOZ.js";import"./chunk-UT2PGJWE.js";import"./chunk-6Y2ASLSF.js";import"./chunk-XRJ4SE6F.js";import"./chunk-LIBYTRNP.js";import"./chunk-3MK77LPM.js";import"./chunk-4U6PRYVA.js";import"./chunk-CZ4AHVKD.js";import"./chunk-Z4V4M3ZT.js";import"./chunk-LLZYEWEK.js";import"./chunk-Z2GS73PT.js";import"./chunk-LF5XB4YN.js";import{h as C}from"./chunk-LNJ3S2LQ.js";var de=["name","description","camp_type","contact_email","imageUrl","externalId"];function oe(a){return a==null?"":String(a).trim()}function re(a,n){let e=[];for(let t of de){let i=oe(a[t]),o=oe(n[t]);i!==o&&e.push(t)}return e}function se(a,n){return n?re(a,n).length===0?"existing":"updated":"new"}function le(a,n){return re(a,n)}var ge=["fileUpload"],M=(a,n)=>n.camp.name;function ue(a,n){if(a&1&&(y(0,"ion-progress-bar",9),s(1,"ion-text"),m(2),l(),y(3,"app-spinner"),s(4,"div",10),y(5,"img",11),l()),a&2){let e=u();x("value",e.progress),r(2),g(e.importing),r(3),x("src",e.url,L)}}function fe(a,n){if(a&1&&(s(0,"ion-item")(1,"ion-label")(2,"div",14)(3,"h3"),m(4),l(),s(5,"ion-badge",15),m(6,"New"),l()(),s(7,"p"),m(8),l()()()),a&2){let e=n.$implicit;r(4),g(e.camp.name),r(4),g(e.camp.description)}}function Ce(a,n){if(a&1&&(s(0,"ion-item-divider")(1,"ion-label")(2,"h2"),m(3),l()()(),P(4,fe,9,2,"ion-item",null,M)),a&2){let e=u(2);r(3),w("New Camps (",e.groupedCamps.get("new").length,")"),r(),U(e.groupedCamps.get("new"))}}function he(a,n){if(a&1&&(s(0,"p",17),m(1),l()),a&2){let e=u().$implicit;r(),w("Changed: ",e.changedFields.join(", "))}}function _e(a,n){if(a&1&&(s(0,"ion-item")(1,"ion-label")(2,"div",14)(3,"h3"),m(4),l(),s(5,"ion-badge",16),m(6,"Updated"),l()(),s(7,"p"),m(8),l(),h(9,he,2,1,"p",17),l()()),a&2){let e=n.$implicit;r(4),g(e.camp.name),r(4),g(e.camp.description),r(),_(e.changedFields&&e.changedFields.length>0?9:-1)}}function xe(a,n){if(a&1&&(s(0,"ion-item-divider")(1,"ion-label")(2,"h2"),m(3),l()()(),P(4,_e,10,3,"ion-item",null,M)),a&2){let e=u(2);r(3),w("Updated Camps (",e.groupedCamps.get("updated").length,")"),r(),U(e.groupedCamps.get("updated"))}}function ve(a,n){if(a&1&&(s(0,"ion-item")(1,"ion-label")(2,"div",14)(3,"h3"),m(4),l(),s(5,"ion-badge",18),m(6,"Existing"),l()(),s(7,"p"),m(8),l()()()),a&2){let e=n.$implicit;r(4),g(e.camp.name),r(4),g(e.camp.description)}}function Ie(a,n){if(a&1&&(s(0,"ion-item-divider")(1,"ion-label")(2,"h2"),m(3),l()()(),P(4,ve,9,2,"ion-item",null,M)),a&2){let e=u(2);r(3),w("Existing Camps (",e.groupedCamps.get("existing").length,")"),r(),U(e.groupedCamps.get("existing"))}}function ye(a,n){if(a&1){let e=T();s(0,"div",7)(1,"div",12)(2,"ion-button",13),F("click",function(){S(e);let i=u();return E(i.doImport())}),m(3,"Import from CSV"),l()(),s(4,"ion-list"),h(5,Ce,6,1),h(6,xe,6,1),h(7,Ie,6,1),l()()}if(a&2){let e=u();r(5),_(e.groupedCamps.get("new")&&e.groupedCamps.get("new").length>0?5:-1),r(),_(e.groupedCamps.get("updated")&&e.groupedCamps.get("updated").length>0?6:-1),r(),_(e.groupedCamps.get("existing")&&e.groupedCamps.get("existing").length>0?7:-1)}}var v=class v{constructor(){this.api=k(te);this.location=k(A);this.vanity=O("");this.isAdmin=!1;this.busy=!1;this.camps=[];this.campsWithIds=new Map;this.groupedCamps=new Map;this.title="Import";this.importing="";this.progress=0;this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);this.url=""}ngOnInit(){this.isAdmin=this.api.lastRoleResponse=="festival",this.isAdmin&&this.fileUpload.nativeElement.click()}doImport(){this.fileUpload.nativeElement.click()}onFileSelected(n){return C(this,null,function*(){let e=n.target.files[0];if(!e)return;let t=new FileReader;t.onload=i=>C(this,null,function*(){var c;let o=(c=i.target)==null?void 0:c.result;yield this.parseCSV(o);try{this.fileUpload.nativeElement.target&&(this.fileUpload.nativeElement.target.value="")}catch(f){console.info(f)}}),t.readAsText(e)})}parseCSV(n){return C(this,null,function*(){let e=ae(n);console.info("items parsed from csv",e),this.camps=[],this.groupedCamps.clear();let t=this.mapColumns(e);if(t){let i=[];for(let p of e){let d=yield this.importCamp(p,t);!!d.name&&i.push(d)}i.sort((p,d)=>p.name>d.name?1:-1);let o=yield this.api.camps({cached:!1}),c=new Map,f=new Map;for(let p of o)c.set(p.name.toLowerCase(),p),p.externalId&&f.set(p.externalId.toLowerCase(),p);let I=new Map;I.set("existing",[]),I.set("new",[]),I.set("updated",[]);for(let p of i){let d=c.get(p.name.toLowerCase());!d&&p.externalId&&(d=f.get(p.externalId.toLowerCase()));let b=se(p,d),me=b==="updated"?le(p,d):void 0;d!=null&&d.id&&this.campsWithIds.set(p.name.toLowerCase(),d.id);let ce={status:b,camp:p,changedFields:me};I.get(b).push(ce),this.camps.push(p)}this.groupedCamps=I,this.title=`Import ${this.camps.length} camps`}})}import(){return C(this,null,function*(){this.busy=!0,this.title="Importing...";let n=0,e=0,t=this.camps.length;for(;this.camps.length>0;){let i;try{if(e++,i=this.camps.pop(),i){let o=i.imageUrl;i.imageUrl=void 0;let c=this.campsWithIds.get(i.name.toLowerCase());c&&(i.id=c),this.importing=i.name,this.progress=e/t;let f=yield this.api.addCamp(i,!0);if(n++,o&&f.id){i.id=f.id;try{yield this.importImage(o,i)}catch{console.error(`Unable to import image for camp ${i.name}: ${o}`)}}}}catch{console.error(`Failed to import ${i==null?void 0:i.name}: ${i==null?void 0:i.description}`)}}this.api.sendMessage(`Imported ${n} of ${e} camps.`),this.busy=!1,this.api.clearCache(),this.location.back()})}toUrl(n){let e=!1,t="";for(let i of n)if(i=="(")e=!0;else if(i==")")if(e=!1,t.length<3)t="";else return t;else e&&(t+=i);return t}importImage(n,e){return C(this,null,function*(){let t=this.toUrl(n),o=yield(yield fetch(t)).blob(),c=yield ie(o,{quality:75,width:300});this.url=URL.createObjectURL(c),e.imageUrl=yield this.api.setImage(c,e.id),yield this.api.addCamp(e,!0)})}mapColumns(n){if(n.length==0)return;let e=n[0],t={pin:"",name:"",id:void 0,camp_type:"Theme Camp",publicEvents:!1};for(let i of Object.keys(e)){let o=i.toLowerCase();o.includes("name")&&!t.name&&(t.name=i),o.includes("description")&&(t.description=i),(o=="type"||o=="camp type"||o=="camptype")&&(t.camp_type=i),o.includes("image")&&(t.image=i),o.includes("logo")&&(t.logo=i),o.includes("email")&&(t.contact_email=i),(o.includes("#")||o=="id")&&(t.externalId=i)}return console.log("map",t),t}importCamp(n,e){return C(this,null,function*(){let t=yield this.api.getCamp(void 0);t.name=n[e.name],e.description?t.description=n[e.description]:t.description=`Details on ${t.name} coming soon...`,e.externalId&&(t.externalId=n[e.externalId]),e.camp_type&&(t.camp_type=n[e.camp_type]),e.contact_email&&(t.contact_email=n[e.contact_email]);let i=e.image,o=e.logo;return i&&(t.imageUrl=n[i]),o&&this.isBlank(t.imageUrl)&&(t.imageUrl=n[o]),t})}isBlank(n){return!n||n.trim()==""}};v.\u0275fac=function(e){return new(e||v)},v.\u0275cmp=R({type:v,selectors:[["app-import"]],viewQuery:function(e,t){if(e&1&&V(ge,7),e&2){let i;B(i=$())&&(t.fileUpload=i.first)}},inputs:{vanity:[1,"vanity"]},decls:14,vars:5,consts:[["fileUpload",""],["color","primary"],["slot","start"],["routerLink","../"],["slot","end",3,"hidden"],[3,"click","disabled"],[3,"fullscreen"],[1,"border"],["type","file","accept",".csv",1,"file-input",3,"change"],[3,"value"],[1,"ion-text-center","vcenter"],[2,"border-radius","2rem",3,"src"],[1,"ion-text-center"],[3,"click"],[1,"camp-header"],["color","success"],["color","warning"],[1,"changed-fields"],["color","medium"]],template:function(e,t){if(e&1){let i=T();s(0,"ion-header")(1,"ion-toolbar",1)(2,"ion-buttons",2),y(3,"ion-back-button"),l(),s(4,"ion-title",3),m(5),l(),s(6,"ion-buttons",4)(7,"ion-button",5),F("click",function(){return S(i),E(t.import())}),m(8,"Import"),l()()()(),s(9,"ion-content",6),h(10,ue,6,3)(11,ye,8,3,"div",7),s(12,"input",8,0),F("change",function(c){return S(i),E(t.onFileSelected(c))}),l()()}e&2&&(r(5),g(t.title),r(),x("hidden",t.camps.length===0),r(),x("disabled",t.busy),r(2),x("fullscreen",!0),r(),_(t.busy?10:11))},dependencies:[X,Y,Q,K,J,H,N,W,z,q,Z,ee,D,ne,G,j],styles:[".camp-header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:var(--spacing-md);margin-bottom:var(--spacing-sm)}.camp-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;flex:1}.changed-fields[_ngcontent-%COMP%]{color:#ff9500;font-size:var(--font-size-xl);margin-top:var(--spacing-base);font-weight:500}"]});var pe=v;export{pe as ImportPage};
