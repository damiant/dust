import{a as rt}from"./chunk-YLPHNW7F.js";import{a as it}from"./chunk-KCPLCCSF.js";import{a as nt}from"./chunk-5B2MUMUK.js";import{K as et}from"./chunk-OQVFSD37.js";import"./chunk-PFLI22GG.js";import{$ as E,Aa as c,Ba as g,Ca as y,Db as j,Dc as Y,E as M,Ec as Z,Fc as tt,H as o,P as V,Ua as B,Wb as D,X as _,Y as x,Za as O,aa as P,ba as A,bc as N,ca as s,cc as Q,da as l,dc as W,ea as C,ja as k,la as U,lc as z,na as u,p as F,ra as R,rc as q,s as b,sa as L,sc as H,t as S,ta as $,tc as G,uc as J,vc as K,yc as X}from"./chunk-FDEJMFAU.js";import"./chunk-JORYF43P.js";import"./chunk-7KGURMOZ.js";import"./chunk-UT2PGJWE.js";import"./chunk-6Y2ASLSF.js";import"./chunk-XRJ4SE6F.js";import"./chunk-LIBYTRNP.js";import"./chunk-3MK77LPM.js";import"./chunk-4U6PRYVA.js";import"./chunk-CZ4AHVKD.js";import"./chunk-Z4V4M3ZT.js";import"./chunk-LLZYEWEK.js";import"./chunk-Z2GS73PT.js";import"./chunk-LF5XB4YN.js";import{h}from"./chunk-LNJ3S2LQ.js";function ot(r,n){let t=["name","description","art_type","contact_email","artist","url","category","externalId"],e=[];for(let i of t){let a=at(r[i]),p=at(n[i]);a!==p&&e.push(i)}return e}function st(r,n){return n?ot(r,n).length===0?"existing":"updated":"new"}function lt(r,n){return ot(r,n)}function at(r){return r==null?"":String(r).trim()}var mt=["fileUpload"],T=(r,n)=>n.art.name;function gt(r,n){if(r&1&&(C(0,"ion-progress-bar",9),s(1,"ion-text"),c(2),l(),C(3,"app-spinner"),s(4,"div",10),C(5,"img",11),l()),r&2){let t=u();A("value",t.progress),o(2),g(t.importing),o(3),A("src",t.url,M)}}function ut(r,n){if(r&1&&(s(0,"ion-item")(1,"ion-label")(2,"div",14)(3,"h3"),c(4),l(),s(5,"ion-badge",15),c(6,"New"),l()(),s(7,"p"),c(8),l()()()),r&2){let t=n.$implicit;o(4),g(t.art.name),o(4),g(t.art.description)}}function ft(r,n){if(r&1&&(s(0,"ion-item-divider")(1,"ion-label")(2,"h2"),c(3),l()()(),E(4,ut,9,2,"ion-item",null,T)),r&2){let t=u(2);o(3),y("New Art (",t.groupedArt.get("new").length,")"),o(),P(t.groupedArt.get("new"))}}function ht(r,n){if(r&1&&(s(0,"p",17),c(1),l()),r&2){let t=u().$implicit;o(),y("Changed: ",t.changedFields.join(", "))}}function _t(r,n){if(r&1&&(s(0,"ion-item")(1,"ion-label")(2,"div",14)(3,"h3"),c(4),l(),s(5,"ion-badge",16),c(6,"Updated"),l()(),s(7,"p"),c(8),l(),_(9,ht,2,1,"p",17),l()()),r&2){let t=n.$implicit;o(4),g(t.art.name),o(4),g(t.art.description),o(),x(t.changedFields&&t.changedFields.length>0?9:-1)}}function xt(r,n){if(r&1&&(s(0,"ion-item-divider")(1,"ion-label")(2,"h2"),c(3),l()()(),E(4,_t,10,3,"ion-item",null,T)),r&2){let t=u(2);o(3),y("Updated Art (",t.groupedArt.get("updated").length,")"),o(),P(t.groupedArt.get("updated"))}}function At(r,n){if(r&1&&(s(0,"ion-item")(1,"ion-label")(2,"div",14)(3,"h3"),c(4),l(),s(5,"ion-badge",18),c(6,"Existing"),l()(),s(7,"p"),c(8),l()()()),r&2){let t=n.$implicit;o(4),g(t.art.name),o(4),g(t.art.description)}}function vt(r,n){if(r&1&&(s(0,"ion-item-divider")(1,"ion-label")(2,"h2"),c(3),l()()(),E(4,At,9,2,"ion-item",null,T)),r&2){let t=u(2);o(3),y("Existing Art (",t.groupedArt.get("existing").length,")"),o(),P(t.groupedArt.get("existing"))}}function It(r,n){if(r&1){let t=k();s(0,"div",7)(1,"div",12)(2,"ion-button",13),U("click",function(){b(t);let i=u();return S(i.doImport())}),c(3,"Import from CSV"),l()(),s(4,"ion-list"),_(5,ft,6,1),_(6,xt,6,1),_(7,vt,6,1),l()()}if(r&2){let t=u();o(5),x(t.groupedArt.get("new")&&t.groupedArt.get("new").length>0?5:-1),o(),x(t.groupedArt.get("updated")&&t.groupedArt.get("updated").length>0?6:-1),o(),x(t.groupedArt.get("existing")&&t.groupedArt.get("existing").length>0?7:-1)}}var v=class v{constructor(){this.api=F(et);this.location=F(O);this.vanity=B("");this.isAdmin=!1;this.busy=!1;this.art=[];this.artWithIds=new Map;this.groupedArt=new Map;this.title="Import Art";this.importing="";this.progress=0;this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);this.url=""}ngOnInit(){this.isAdmin=this.api.lastRoleResponse=="festival",this.isAdmin&&this.fileUpload.nativeElement.click()}doImport(){this.fileUpload.nativeElement.click()}onFileSelected(n){return h(this,null,function*(){let t=n.target.files[0];if(!t)return;let e=new FileReader;e.onload=i=>h(this,null,function*(){var p;let a=(p=i.target)==null?void 0:p.result;yield this.parseCSV(a);try{this.fileUpload.nativeElement.target&&(this.fileUpload.nativeElement.target.value="")}catch(f){console.info(f)}}),e.readAsText(t)})}parseCSV(n){return h(this,null,function*(){let t=rt(n);console.info(t),this.art=[],this.groupedArt.clear();let e=this.mapColumns(t);if(e){let i=[];for(let d of t){let m=yield this.importArt(d,e);!!m.name&&i.push(m)}i.sort((d,m)=>d.name>m.name?1:-1);let a=yield this.api.art({cached:!1}),p=new Map,f=new Map;for(let d of a)p.set(d.name.toLowerCase(),d),d.externalId&&f.set(d.externalId.toLowerCase(),d);let I=new Map;I.set("existing",[]),I.set("new",[]),I.set("updated",[]);for(let d of i){let m=p.get(d.name.toLowerCase());!m&&d.externalId&&(m=f.get(d.externalId.toLowerCase()));let w=st(d,m),ct=w==="updated"?lt(d,m):void 0;m!=null&&m.id&&this.artWithIds.set(d.name.toLowerCase(),m.id);let pt={status:w,art:d,changedFields:ct};I.get(w).push(pt),this.art.push(d)}this.groupedArt=I,this.title=`Import ${this.art.length} art items`}})}import(){return h(this,null,function*(){this.busy=!0,this.title="Importing...";let n=0,t=0,e=this.art.length;for(;this.art.length>0;){let i;try{if(t++,i=this.art.pop(),i){let a=i.imageUrl;i.imageUrl=void 0;let p=this.artWithIds.get(i.name.toLowerCase());p&&(i.id=p),this.importing=i.name,this.progress=t/e;let f=yield this.api.addArt(i);if(n++,a&&f.id){i.id=f.id;try{yield this.importImage(a,i)}catch{console.error(`Unable to import image for art ${i.name}: ${a}`)}}}}catch{console.error(`Failed to import ${i==null?void 0:i.name}: ${i==null?void 0:i.description}`)}}this.api.sendMessage(`Imported ${n} of ${t} art items.`),this.busy=!1,this.api.clearCache(),this.location.back()})}toUrl(n){let t=!1,e="";for(let i of n)if(i=="(")t=!0;else if(i==")")if(t=!1,e.length<3)e="";else return e;else t&&(e+=i);return e}importImage(n,t){return h(this,null,function*(){let e=this.toUrl(n),a=yield(yield fetch(e)).blob(),p=yield it(a,{quality:75,width:300});this.url=URL.createObjectURL(p),t.imageUrl=yield this.api.setImage(p,t.id),yield this.api.addArt(t)})}mapColumns(n){if(n.length==0)return;let t=n[0],e={pin:"",name:"",category:"",id:void 0,art_type:"Art"};for(let i of Object.keys(t)){let a=i.toLowerCase();a.includes("name")&&!e.name&&!a.includes("artist name")&&(e.name=i),a=="title"&&!e.name&&(e.name=i),a.includes("art project")&&!e.name&&(e.name=i),a.includes("description")&&(e.description=i),a.includes("type")&&(e.art_type=i),(a.includes("web")||a.includes("url"))&&(e.url=i),a.includes("image")&&(e.image=i),a.includes("logo")&&(e.logo=i),a.includes("artist")&&(e.artist=i),a.includes("email")&&(e.contact_email=i),(a.includes("#")||a=="id")&&(e.externalId=i)}return console.log("map",e),e}importArt(n,t){return h(this,null,function*(){let e=yield this.api.getArt(void 0);e.name=n[t.name],t.description?e.description=n[t.description]:e.description=`Details on ${e.name} coming soon...`,t.externalId&&(e.externalId=n[t.externalId]),t.artist&&(e.artist=n[t.artist]),t.url&&(e.url=n[t.url]),t.art_type&&(e.art_type=n[t.art_type]),t.contact_email&&(e.contact_email=n[t.contact_email]);let i=t.image,a=t.logo;return i&&(e.imageUrl=n[i]),a&&this.isBlank(e.imageUrl)&&(e.imageUrl=n[a]),e})}isBlank(n){return!n||n.trim()==""}};v.\u0275fac=function(t){return new(t||v)},v.\u0275cmp=V({type:v,selectors:[["app-import-art"]],viewQuery:function(t,e){if(t&1&&R(mt,7),t&2){let i;L(i=$())&&(e.fileUpload=i.first)}},inputs:{vanity:[1,"vanity"]},decls:14,vars:5,consts:[["fileUpload",""],["color","primary"],["slot","start"],["routerLink","../"],["slot","end",3,"hidden"],[3,"click","disabled"],[3,"fullscreen"],[1,"border"],["type","file","accept",".csv",1,"file-input",3,"change"],[3,"value"],[1,"ion-text-center","vcenter"],[2,"border-radius","2rem",3,"src"],[1,"ion-text-center"],[3,"click"],[1,"art-header"],["color","success"],["color","warning"],[1,"changed-fields"],["color","medium"]],template:function(t,e){if(t&1){let i=k();s(0,"ion-header")(1,"ion-toolbar",1)(2,"ion-buttons",2),C(3,"ion-back-button"),l(),s(4,"ion-title",3),c(5),l(),s(6,"ion-buttons",4)(7,"ion-button",5),U("click",function(){return b(i),S(e.import())}),c(8,"Import"),l()()()(),s(9,"ion-content",6),_(10,gt,6,3)(11,It,8,3,"div",7),s(12,"input",8,0),U("change",function(p){return b(i),S(e.onFileSelected(p))}),l()()}t&2&&(o(5),g(e.title),o(),A("hidden",e.art.length===0),o(),A("disabled",e.busy),o(2),A("fullscreen",!0),o(),x(e.busy?10:11))},dependencies:[X,Y,Q,K,J,H,D,W,z,q,Z,tt,j,nt,G,N],styles:[".art-header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:var(--spacing-md);margin-bottom:var(--spacing-sm)}.art-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;flex:1}.changed-fields[_ngcontent-%COMP%]{color:#ff9500;font-size:var(--font-size-xl);margin-top:var(--spacing-base);font-weight:500}"]});var dt=v;export{dt as ImportArtPage};
