import{a as De}from"./chunk-YLPHNW7F.js";import{a as Me}from"./chunk-NIJZXRAZ.js";import{a as Pe}from"./chunk-KCPLCCSF.js";import{a as Le}from"./chunk-5B2MUMUK.js";import"./chunk-LIWDDRYP.js";import{B as ke,F as j,K as Te,a as Se,h as G,s as O}from"./chunk-OQVFSD37.js";import"./chunk-PFLI22GG.js";import{$ as F,Aa as p,Ba as I,Bc as ye,Ca as A,Da as X,Db as ie,Dc as Ce,E as Z,Eb as oe,Ec as we,Fa as U,Fc as Ie,Ga as B,H as d,Ha as R,Oc as xe,P as Q,Pc as be,Sc as Ee,T as Y,Wb as re,X as M,Xb as ae,Y as D,Z as q,Za as ee,_ as z,aa as $,ba as w,ca as c,cc as se,da as s,dc as le,ea as b,ec as ce,fc as de,gc as pe,hc as me,ic as ue,ja as V,la as E,lc as fe,na as f,p as N,ra as H,rc as he,s as y,sa as J,sc as ge,t as C,ta as K,tb as te,vc as _e,wb as ne,yc as ve}from"./chunk-FDEJMFAU.js";import"./chunk-JORYF43P.js";import"./chunk-7KGURMOZ.js";import"./chunk-UT2PGJWE.js";import"./chunk-6Y2ASLSF.js";import"./chunk-XRJ4SE6F.js";import"./chunk-LIBYTRNP.js";import"./chunk-3MK77LPM.js";import"./chunk-4U6PRYVA.js";import"./chunk-CZ4AHVKD.js";import"./chunk-Z4V4M3ZT.js";import"./chunk-LLZYEWEK.js";import"./chunk-Z2GS73PT.js";import"./chunk-LF5XB4YN.js";import{h as S}from"./chunk-LNJ3S2LQ.js";var $e=["fileUpload"];function Ve(a,i){if(a&1&&(c(0,"ion-select-option",13),p(1),s()),a&2){let e=i.$implicit;w("value",e.id),d(),I(e.name)}}function Ae(a,i){if(a&1&&(c(0,"ion-select-option",13),p(1),s()),a&2){let e=i.$implicit;w("value",e.id),d(),I(e.name)}}function Ue(a,i){if(a&1){let e=V();c(0,"ion-content",9)(1,"div",9)(2,"h1"),p(3,"Unknown Location"),s(),c(4,"p"),p(5),s(),c(6,"p"),p(7),s(),c(8,"ion-radio-group",10),R("ngModelChange",function(n){y(e);let o=f();return B(o.locationType,n)||(o.locationType=n),C(n)}),c(9,"ion-radio",11),p(10,"Camp"),s(),c(11,"ion-select",12),E("ionChange",function(){y(e);let n=f();return C(n.locationType="camp")}),R("ngModelChange",function(n){y(e);let o=f();return B(o.selectedCamp,n)||(o.selectedCamp=n),C(n)}),F(12,Ve,2,2,"ion-select-option",13,z),s(),c(14,"ion-radio",14),p(15,"Art"),s(),c(16,"ion-select",15),E("ionChange",function(){y(e);let n=f();return C(n.locationType="art")}),R("ngModelChange",function(n){y(e);let o=f();return B(o.selectedArt,n)||(o.selectedArt=n),C(n)}),F(17,Ae,2,2,"ion-select-option",13,z),s(),c(19,"ion-radio",16),p(20,"Open Camping / Other"),s(),b(21,"br"),s()()(),c(22,"ion-toolbar",17)(23,"ion-button",18),E("click",function(){y(e);let n=f();return C(n.applyTransform(n.selectedCamp,n.selectedArt,n.locationType,n.unknownLocation))}),p(24,"Apply"),s()()}if(a&2){let e=f();d(5),A('Choose the camp or art that matches the location "',e.unknownLocation,'"'),d(2),I(e.eventInfo),d(),U("ngModel",e.locationType),d(3),w("value",e.selectedCamp),U("ngModel",e.selectedCamp),d(),$(e.camps),d(4),w("value",e.selectedArt),U("ngModel",e.selectedArt),d(),$(e.art)}}function Be(a,i){if(a&1&&(b(0,"ion-progress-bar",13),c(1,"ion-text"),p(2),s(),b(3,"app-spinner"),c(4,"div",19),b(5,"img",20),s()),a&2){let e=f();w("value",e.progress),d(2),I(e.importing),d(3),w("src",e.url,Z)}}function Re(a,i){if(a&1&&(c(0,"p",22),p(1),s()),a&2){let e=f(3);d(),X("There are ",e.errors.length," problems found in the CSV. You can choose to import but it is preferable to fix the errors in red below before importing. ",e.otherErrors)}}function Ne(a,i){a&1&&(c(0,"p",22),p(1,'Click "Complete Import" to perform the import'),s())}function ze(a,i){if(a&1&&(c(0,"ion-card-subtitle",25),p(1),s()),a&2){let e=f().$implicit;d(),I(e.error)}}function Ge(a,i){var e;if(a&1&&(c(0,"ion-card-subtitle"),p(1),s()),a&2){let t=f().$implicit;d(),A("",(e=t.timeString)!=null?e:"BAD TIME"," ")}}function je(a,i){if(a&1&&(c(0,"ion-item",23)(1,"ion-card",24)(2,"ion-card-header")(3,"ion-card-title"),p(4),s(),M(5,ze,2,1,"ion-card-subtitle",25)(6,Ge,2,1,"ion-card-subtitle"),s(),c(7,"ion-card-content"),p(8),b(9,"br"),c(10,"b"),p(11),s()()()()),a&2){let e=i.$implicit;d(4),I(e.title),d(),D(!e.hosted_by_camp||e.error?5:6),d(3),I(e.description),d(3),I(e.event_type)}}function Ze(a,i){if(a&1&&(c(0,"ion-list")(1,"h1"),p(2),s(),M(3,Re,2,2,"p",22)(4,Ne,2,0,"p",22),F(5,je,12,4,"ion-item",23,q),s()),a&2){let e=f(2);d(2),A("",e.events.length," Events can be imported"),d(),D(e.errors.length>0?3:4),d(2),$(e.events)}}function Qe(a,i){if(a&1){let e=V();c(0,"div",6)(1,"div",21)(2,"ion-button",18),E("click",function(){y(e);let n=f();return C(n.doImport())}),p(3,"Import from CSV"),s()(),M(4,Ze,7,2,"ion-list"),s()}if(a&2){let e=f();d(4),D(e.events.length>0||e.errors.length>0?4:-1)}}var k=class k{constructor(){this.api=N(Te);this.location=N(ee);this.busy=!1;this.isAdmin=!1;this.importing="";this.title="Import";this.otherErrors="";this.locationType="camp";this.progress=0;this.url="";this.events=[];this.camps=[];this.art=[];this.errors=[];this.showSelectCamp=!1;this.unknownLocation="";this.eventInfo="";this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}ngOnInit(){this.isAdmin=this.api.lastRoleResponse=="festival",this.isAdmin&&this.fileUpload.nativeElement.click()}doImport(){this.fileUpload.nativeElement.click()}onFileSelected(i){return S(this,null,function*(){let e=i.target.files[0];if(!e)return;let t=new FileReader;t.onload=n=>S(this,null,function*(){var r;let o=(r=n.target)==null?void 0:r.result;this.parseCSV(o)}),t.readAsText(e)})}applyTransform(i,e,t,n){this.showSelectCamp=!1,t=="other"&&(i=void 0,e=void 0),t=="art"&&(i=void 0),t=="camp"&&(e=void 0),n&&(localStorage.setItem(`match-camp-${n}`,i),localStorage.setItem(`match-art-${n}`,e),localStorage.setItem(`match-type-${n}`,t),setTimeout(()=>{this.fixUnknownLocations()},1e3))}parseCSV(i){return S(this,null,function*(){let e=De(i+`
`);this.events=[];let t=this.mapColumns(e);this.camps=yield this.api.camps({cached:!1}),this.art=yield this.api.art({cached:!1}),this.errors=[],this.otherErrors="";let n=yield this.api.events({cached:!1}),o=0;if(t){for(let r of e)if(this.isBlankLine(r))console.log("Ignored blank line");else{let l=this.importEvent(r,t);this.isDuplicate(l,n)?(l.error="This event already exists and wont be imported",o++):this.events.push(l)}this.events=this.events.sort((r,l)=>r.title>l.title?1:-1),this.title=`Import ${this.events.length} events`,o>0&&(this.otherErrors=` There are ${o} duplicate events already imported that will be skipped.`)}this.fixUnknownLocations(),this.fileUpload.nativeElement.target&&(this.fileUpload.nativeElement.target.value="")})}fixUnknownLocations(){for(let i of this.events)if(i.unknownLocation){let e=localStorage[`match-camp-${i.unknownLocation}`],t=localStorage[`match-art-${i.unknownLocation}`],n=localStorage[`match-type-${i.unknownLocation}`];if(n=="camp")i.hosted_by_camp=parseInt(e),i.unknownLocation=void 0,i.other_location=void 0;else if(n=="art")i.located_at_art=t,i.unknownLocation=void 0,i.other_location=void 0;else if(n=="other")i.other_location=i.unknownLocation,i.hosted_by_camp=void 0,i.located_at_art=void 0;else if(e)i.hosted_by_camp=parseInt(e),i.unknownLocation=void 0;else{this.showSelectCamp=!0,this.unknownLocation=i.unknownLocation,this.eventInfo=`${i.title}. ${i.description}`,console.log("unknown location is",i.unknownLocation);return}}}isDuplicate(i,e){for(let t of e)if(t.occurrence_set==i.occurrence_set&&t.title==i.title&&t.description==i.description)return!0;return!1}import(){return S(this,null,function*(){this.busy=!0,this.title="Importing...";let i=0,e=0,t=this.events.length;for(;this.events.length>0;){let n;try{if(e++,n=this.events.pop(),n){let o=n.imageUrl;n.imageUrl=void 0,this.importing=n.title,this.progress=e/t;let r=yield this.api.addEvent(n);if(i++,o&&r.id){n.id=r.id;try{yield this.importImage(o,n)}catch{console.error(`Unable to import image for event ${n.title}: ${o}`)}}}}catch{console.error(`Failed to import ${n==null?void 0:n.title}: ${n==null?void 0:n.description}`)}}this.api.sendMessage(`Imported ${i} of ${e} events.`),this.busy=!1,this.api.clearCache(),this.location.back()})}isBlankLine(i){for(let e of Object.keys(i))if(i[e]&&i[e]!="")return!1;return!0}toUrl(i){let e=!1,t="";for(let n of i)if(n=="(")e=!0;else if(n==")")if(e=!1,t.length<3)t="";else return t;else e&&(t+=n);return t}importImage(i,e){return S(this,null,function*(){let t=this.toUrl(i),o=yield(yield fetch(t)).blob(),r=yield Pe(o,{quality:75,width:300});this.url=URL.createObjectURL(r),e.imageUrl=yield this.api.setImage(r,e.id),yield this.api.addEvent(e)})}importEvent(i,e){var L,x;let t={description:"",title:"",hosted_by_camp:void 0,occurrence_set:"[]",id:void 0,event_type:"Event",error:void 0,unknownLocation:void 0};t.title=i[e.title],t.description=i[e.description],t.event_type=i[e.event_type],t.event_type||(t.event_type=this.guessEventType(t.title,t.description)),t.event_type=="Yes"&&(t.event_type="Class/Workshop");let n=e.image,o=e.logo,r=e.startDay,l=e.endDay,g=e.start_time,_=e.end_time,m=i[e.location],v,h=!1;for(let u of this.camps)u.name.toLowerCase()=="unknown"&&(v=u),(m==null?void 0:m.toLowerCase().trim())==((L=u.name)==null?void 0:L.toLowerCase().trim())&&(t.hosted_by_camp=u.id,h=!0);let T=localStorage[`match-camp-${m}`],P=localStorage[`match-art-${m}`],W=localStorage[`match-type-${m}`];h||(T&&!t.hosted_by_camp?(t.hosted_by_camp=parseInt(T),h=!0):P&&!t.located_at_art&&(t.located_at_art=P,h=!0)),W=="other"&&(t.other_location=m,h=!0),h||(this.errors.push(`Location of event ${t.title} has an unknown location "${m}"`),t.error=`Unknown Location "${m}"`,t.unknownLocation=m,t.hosted_by_camp=v?v.id:void 0),n&&(t.imageUrl=i[n]),o&&this.isBlank(t.imageUrl)&&(t.imageUrl=i[o]);try{let u=this.multiOccurenceSet(i[r],i[l],i[g],i[_]);if(u.length>=1){let We=new Date(u[0].start_time),Fe=new Date(u[0].end_time);t.timeString=(x=Se(We,Fe,void 0,this.api.currentTimeZone()))==null?void 0:x.long}t.occurrence_set=JSON.stringify(u)}catch(u){this.errors.push(`There is an error with the event ${t.title}: ${u}`),t.error=`${u}`,console.error(u)}return t}multiOccurenceSet(i,e,t,n){let o=this.multiDay(i),r=[];for(let l of o){let g=this.convertToOccurrenceSet(l,e,t,n);(g.start_time.includes("NaN")||g.end_time.includes("NaN"))&&this.errors.push("The event times are invalid"),r.push(g)}return r}multiDay(i){let e=/\b(?:Mon(?:day)?|Tue(?:sday)?|Wed(?:nesday)?|Thu(?:rsday)?|Fri(?:day)?|Sat(?:urday)?|Sun(?:day)?),\s+[A-Z][a-z]+\s+\d{1,2}(?:st|nd|rd|th)?/g;return i.match(e)||[i]}guessEventType(i,e){let t=i?i.toLowerCase().trim():"",n=e?e.toLowerCase().trim():"",o={yoga:"Yoga/Movement/Fitness",class:"Class/Workshop",workshop:"Class/Workshop",conversation:"Class/Workshop",101:"Class/Workshop","learn to":"Class/Workshop","talk about":"Class/Workshop",relax:"Self Care","to play":"Games",films:"Performance","make a":"Arts & Crafts",meditation:"Ritual/Ceremony",ceremony:"Ritual/Ceremony",live:"Live Music",tasting:"Food/Drink",shibari:"Class/Workshop",karaoke:"Performance","happy hour":"Food/Drink",party:"Gathering/Party",spins:"Gathering/Party",djs:"Gathering/Party",dancing:"Gathering/Party",dance:"Gathering/Party",music:"Gathering/Party",movie:"Performance",pizza:"Food/Drink","fire spin":"Fire/Spectacle",session:"Class/Workshop",beginners:"Class/Workshop","safety meeting":"Class/Workshop",dungeon:"Mature Audiences",sex:"Mature Audiences",orgy:"Mature Audiences",tea:"Food/Drink",games:"Games","photo booth":"Games",cacao:"Food/Drink","bloody mary":"Food/Drink",homebrew:"Food/Drink","bring your cup":"Food/Drink",cookies:"Food/Drink",eating:"Food/Drink","drum circle":"Live Music",perform:"Performance",stroll:"Parade",acoustic:"Live Music","bar crawl":"Parade"};for(let r of Object.keys(o))if(t.includes(r)||n.includes(r))return o[r];return"Miscellaneous"}convertToOccurrenceSet(i,e,t,n){var l;if(i=(l=j(i,'"',""))==null?void 0:l.trim(),e=j(e,'"',""),e||(e=i),t.length>=19&&n.length>=19)return{start_time:t,end_time:n};t==""&&n==""&&(t="00:00am",n="11:59:59pm"),G(":",t)==2&&(t=t.replace(":00 ","")),G(":",n)==2&&(n=n.replace(":00 ",""));let o=this.toISODate(i+" "+t,void 0),r=this.toISODate(e+" "+n,o);return{start_time:o,end_time:r}}toIsoDateSlash(i,e){let t=i.split(" "),n=new Date(t[0]).toISOString().split("T")[0].split("-"),o=parseInt(n[0],10),r=parseInt(n[1],10)-1,l=parseInt(n[2],10),g=t[1].split(":"),_=parseInt(g[0],10),m=parseInt(g[1],10);i.toLowerCase().includes("pm")&&_!=12&&(_+=12);let v=O(o,r,l,_,m).replace("Z","");return e&&new Date(v).getTime()-new Date(e).getTime()<0&&(l=l+1,l>this.daysInMonth(r,o)&&(l=1,r++,r>12&&(r=0,o++)),v=O(o,r,l,_,m).replace("Z","")),v}toISODate(i,e){if(i.includes(" AM")&&(i=i.replace(" AM","am")),i.includes(" PM")&&(i=i.replace(" PM","pm")),i.includes("/"))return this.toIsoDateSlash(i,e);let t=i.split(" "),n,o=ke(void 0,"short"),r,l,g=0;for(let h of t){let T=Number.parseInt(h,10);!Number.isNaN(T)&&!n&&(n=T);let P=o.find(x=>h.toLowerCase().startsWith(x.toLowerCase()));P&&(r=P),h.toLowerCase()=="midnight"&&(l=23,g=59);let W=h.toLowerCase().endsWith("pm"),L=h.toLowerCase().endsWith("am");if(L||W||h.includes(":")){let x=h.toLowerCase().replace("pm","").replace("am","");if(x.includes(":")){let u=x.split(":");x=u[0],g=Number.parseInt(u[1])}l=Number.parseInt(x),W&&l<=11&&(l+=12),L&&l==12&&(l=0)}}if(l==null)throw new Error(`'${i}' is missing the time`);if(r==null)throw new Error(`'${i}' is missing the month`);if(n==null)throw new Error(`'${i}' is missing the day`);let _=o.indexOf(r),m=new Date().getFullYear(),v=O(m,_,n,l,g).replace("Z","");return e&&new Date(v).getTime()-new Date(e).getTime()<0&&(n=n+1,n>this.daysInMonth(_,m)&&(n=1,_++,_>12&&(_=0,m++)),v=O(m,_,n,l,g).replace("Z","")),v}daysInMonth(i,e){return new Date(e,i+1,0).getDate()}isBlank(i){return!i||i.trim()==""}mapColumns(i){if(i.length==0)return;let e=i[0],t={title:"",description:"",event_type:"",hosted_by_camp:void 0,occurrence_set:"",id:void 0};for(let n of Object.keys(e)){let o=n.toLowerCase();o.includes("event name")&&(t.title=n),o.includes("name")&&!o.includes("camp name")&&(t.title=n),o.includes("title")&&(t.title=n),o.includes("description")&&(t.description=n),o.includes("day")&&!t.startDay&&(t.startDay=n),o.includes("date")&&!t.startDay&&(t.startDay=n),o.includes("start date")&&(t.startDay=n),o.includes("end date")&&(t.endDay=n),o.includes("image")&&(t.image=n),o.includes("logo")&&(t.logo=n),o.includes("type")&&(t.event_type=n),(o.includes("start time")||o.includes("starttime"))&&(t.start_time=n),(o.includes("end time")||o.includes("endtime"))&&(t.end_time=n),o.includes("location")&&(t.location=n)}return t}};k.\u0275fac=function(e){return new(e||k)},k.\u0275cmp=Q({type:k,selectors:[["app-import-events"]],viewQuery:function(e,t){if(e&1&&H($e,7),e&2){let n;J(n=K())&&(t.fileUpload=n.first)}},decls:14,vars:5,consts:[["fileUpload",""],["color","primary"],["slot","start"],["routerLink","../"],[3,"fullscreen"],[3,"isOpen"],[1,"border"],["type","file","accept",".csv",1,"file-input",3,"change"],["title","Complete Import",3,"press","hidden"],[1,"ion-padding"],[3,"ngModelChange","ngModel"],["labelPlacement","end","value","camp"],["label"," ","interface","popover","placeholder","Select camp for event",3,"ionChange","ngModelChange","value","ngModel"],[3,"value"],["labelPlacement","end","value","art"],["label"," ","interface","popover","placeholder","Select art for event",3,"ionChange","ngModelChange","value","ngModel"],["labelPlacement","end","value","other"],[1,"ion-text-center","ion-padding"],[3,"click"],[1,"ion-text-center","vcenter"],[2,"border-radius","2rem",3,"src"],[1,"ion-text-center"],[1,"error","ion-padding-left","ion-padding-right"],["lines","none"],["mode","ios"],[1,"error"]],template:function(e,t){if(e&1){let n=V();c(0,"ion-header")(1,"ion-toolbar",1)(2,"ion-buttons",2),b(3,"ion-back-button"),s(),c(4,"ion-title",3),p(5),s()()(),c(6,"ion-content",4)(7,"ion-modal",5),Y(8,Ue,25,7,"ng-template"),s(),M(9,Be,6,3)(10,Qe,5,1,"div",6),c(11,"input",7,0),E("change",function(r){return y(n),C(t.onFileSelected(r))}),s(),c(13,"app-footer",8),E("press",function(){return y(n),C(t.import())}),s()()}e&2&&(d(5),I(t.title),d(),w("fullscreen",!0),d(),w("isOpen",t.showSelectCamp),d(2),D(t.busy?9:10),d(4),w("hidden",t.busy||t.events.length===0))},dependencies:[xe,be,ae,pe,de,me,ue,ce,re,ge,_e,Ce,ve,se,le,fe,he,we,Ie,ie,te,ne,Le,Me,oe,ye,Ee],styles:[".error[_ngcontent-%COMP%]{color:red;font-weight:700}ion-card-title[_ngcontent-%COMP%]{font-size:var(--font-size-medium)!important}ion-card-subtitle[_ngcontent-%COMP%]{font-size:var(--font-size-base)}ion-card-content[_ngcontent-%COMP%]{font-size:var(--font-size-base)}ion-select[_ngcontent-%COMP%]{width:50%;margin-left:50%}ion-radio[_ngcontent-%COMP%]{float:left;margin-top:var(--spacing-base)}"]});var Oe=k;export{Oe as ImportEventsPage};
