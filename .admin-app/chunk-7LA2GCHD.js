import{a as De}from"./chunk-QTBNLBDF.js";import{a as Me}from"./chunk-XQO4ZLWR.js";import{a as Pe}from"./chunk-KCPLCCSF.js";import{a as Le}from"./chunk-5EUBO754.js";import{B as ke,E as j,I as Te,a as Se,h as z,s as O}from"./chunk-CXIDEVKY.js";import"./chunk-PFLI22GG.js";import{$,$b as de,Aa as I,Ba as A,Ca as X,D as Z,Ea as U,Ec as xe,Fa as B,Fc as Ee,G as d,Ga as R,Ic as be,O as Q,Rb as re,S as Y,Sb as ae,W as k,Wa as ee,X as T,Y as q,Yb as se,Z as G,Zb as le,_ as F,_b as ce,aa as w,ac as pe,ba as c,bc as me,ca as s,cc as ue,da as E,ec as fe,ia as V,ka as b,kc as he,lc as ge,ma as f,nc as _e,ob as te,p as N,pc as ve,qa as H,ra as J,rb as ne,s as y,sa as K,sc as ye,t as C,uc as Ce,vc as we,wc as Ie,yb as ie,za as p,zb as oe}from"./chunk-GPCT4GNB.js";import"./chunk-JORYF43P.js";import"./chunk-7KGURMOZ.js";import"./chunk-UT2PGJWE.js";import"./chunk-6Y2ASLSF.js";import"./chunk-XRJ4SE6F.js";import"./chunk-LIBYTRNP.js";import"./chunk-3MK77LPM.js";import"./chunk-4U6PRYVA.js";import"./chunk-CZ4AHVKD.js";import"./chunk-Z4V4M3ZT.js";import"./chunk-LLZYEWEK.js";import"./chunk-Z2GS73PT.js";import"./chunk-LF5XB4YN.js";import{h as S}from"./chunk-LNJ3S2LQ.js";var $e=["fileUpload"];function Ve(a,n){if(a&1&&(c(0,"ion-select-option",13),p(1),s()),a&2){let e=n.$implicit;w("value",e.id),d(),I(e.name)}}function Ae(a,n){if(a&1&&(c(0,"ion-select-option",13),p(1),s()),a&2){let e=n.$implicit;w("value",e.id),d(),I(e.name)}}function Ue(a,n){if(a&1){let e=V();c(0,"ion-content",9)(1,"div",9)(2,"h1"),p(3,"Unknown Location"),s(),c(4,"p"),p(5),s(),c(6,"p"),p(7),s(),c(8,"ion-radio-group",10),R("ngModelChange",function(i){y(e);let o=f();return B(o.locationType,i)||(o.locationType=i),C(i)}),c(9,"ion-radio",11),p(10,"Camp"),s(),c(11,"ion-select",12),b("ionChange",function(){y(e);let i=f();return C(i.locationType="camp")}),R("ngModelChange",function(i){y(e);let o=f();return B(o.selectedCamp,i)||(o.selectedCamp=i),C(i)}),F(12,Ve,2,2,"ion-select-option",13,G),s(),c(14,"ion-radio",14),p(15,"Art"),s(),c(16,"ion-select",15),b("ionChange",function(){y(e);let i=f();return C(i.locationType="art")}),R("ngModelChange",function(i){y(e);let o=f();return B(o.selectedArt,i)||(o.selectedArt=i),C(i)}),F(17,Ae,2,2,"ion-select-option",13,G),s(),c(19,"ion-radio",16),p(20,"Open Camping / Other"),s(),E(21,"br"),s()()(),c(22,"ion-toolbar",17)(23,"ion-button",18),b("click",function(){y(e);let i=f();return C(i.applyTransform(i.selectedCamp,i.selectedArt,i.locationType,i.unknownLocation))}),p(24,"Apply"),s()()}if(a&2){let e=f();d(5),A('Choose the camp or art that matches the location "',e.unknownLocation,'"'),d(2),I(e.eventInfo),d(),U("ngModel",e.locationType),d(3),w("value",e.selectedCamp),U("ngModel",e.selectedCamp),d(),$(e.camps),d(4),w("value",e.selectedArt),U("ngModel",e.selectedArt),d(),$(e.art)}}function Be(a,n){if(a&1&&(E(0,"ion-progress-bar",13),c(1,"ion-text"),p(2),s(),E(3,"app-spinner"),c(4,"div",19),E(5,"img",20),s()),a&2){let e=f();w("value",e.progress),d(2),I(e.importing),d(3),w("src",e.url,Z)}}function Re(a,n){if(a&1){let e=V();c(0,"div",21)(1,"ion-button",18),b("click",function(){y(e);let i=f(2);return C(i.doImport())}),p(2,"Import from CSV"),s()()}}function Ne(a,n){if(a&1&&(c(0,"p",22),p(1),s()),a&2){let e=f(3);d(),X("There are ",e.errors.length," problems found in the CSV. You can choose to import but it is preferable to fix the errors in red below before importing. ",e.otherErrors)}}function Ge(a,n){a&1&&(c(0,"p",22),p(1,'Click "Complete Import" to perform the import'),s())}function ze(a,n){if(a&1&&(c(0,"ion-card-subtitle",25),p(1),s()),a&2){let e=f().$implicit;d(),I(e.error)}}function je(a,n){var e;if(a&1&&(c(0,"ion-card-subtitle"),p(1),s()),a&2){let t=f().$implicit;d(),A("",(e=t.timeString)!=null?e:"BAD TIME"," ")}}function Ze(a,n){if(a&1&&(c(0,"ion-item",23)(1,"ion-card",24)(2,"ion-card-header")(3,"ion-card-title"),p(4),s(),k(5,ze,2,1,"ion-card-subtitle",25)(6,je,2,1,"ion-card-subtitle"),s(),c(7,"ion-card-content"),p(8),E(9,"br"),c(10,"b"),p(11),s()()()()),a&2){let e=n.$implicit;d(4),I(e.title),d(),T(!e.hosted_by_camp||e.error?5:6),d(3),I(e.description),d(3),I(e.event_type)}}function Qe(a,n){if(a&1&&(c(0,"ion-list")(1,"h1"),p(2),s(),k(3,Ne,2,2,"p",22)(4,Ge,2,0,"p",22),F(5,Ze,12,4,"ion-item",23,q),s()),a&2){let e=f(2);d(2),A("",e.events.length," Events can be imported"),d(),T(e.errors.length>0?3:4),d(2),$(e.events)}}function Ye(a,n){if(a&1&&(c(0,"div",6),k(1,Re,3,0,"div",21),k(2,Qe,7,2,"ion-list"),s()),a&2){let e=f();d(),T(e.isSafari&&e.events.length===0?1:-1),d(),T(e.events.length>0||e.errors.length>0?2:-1)}}var P=class P{constructor(){this.api=N(Te);this.location=N(ee);this.busy=!1;this.isAdmin=!1;this.importing="";this.title="Import";this.otherErrors="";this.locationType="camp";this.progress=0;this.url="";this.events=[];this.camps=[];this.art=[];this.errors=[];this.showSelectCamp=!1;this.unknownLocation="";this.eventInfo="";this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}ngOnInit(){this.isAdmin=this.api.lastRoleResponse=="festival",this.isAdmin&&this.fileUpload.nativeElement.click()}doImport(){this.fileUpload.nativeElement.click()}onFileSelected(n){return S(this,null,function*(){let e=n.target.files[0];if(!e)return;let t=new FileReader;t.onload=i=>S(this,null,function*(){var r;let o=(r=i.target)==null?void 0:r.result;this.parseCSV(o)}),t.readAsText(e)})}applyTransform(n,e,t,i){this.showSelectCamp=!1,t=="other"&&(n=void 0,e=void 0),t=="art"&&(n=void 0),t=="camp"&&(e=void 0),i&&(localStorage.setItem(`match-camp-${i}`,n),localStorage.setItem(`match-art-${i}`,e),localStorage.setItem(`match-type-${i}`,t),setTimeout(()=>{this.fixUnknownLocations()},1e3))}parseCSV(n){return S(this,null,function*(){let e=De(n+`
`);this.events=[];let t=this.mapColumns(e);this.camps=yield this.api.camps({cached:!1}),this.art=yield this.api.art({cached:!1}),this.errors=[],this.otherErrors="";let i=yield this.api.events({cached:!1}),o=0;if(t){for(let r of e)if(this.isBlankLine(r))console.log("Ignored blank line");else{let l=this.importEvent(r,t);this.isDuplicate(l,i)?(l.error="This event already exists and wont be imported",o++):this.events.push(l)}this.events=this.events.sort((r,l)=>r.title>l.title?1:-1),this.title=`Import ${this.events.length} events`,o>0&&(this.otherErrors=` There are ${o} duplicate events already imported that will be skipped.`)}this.fixUnknownLocations(),this.fileUpload.nativeElement.target&&(this.fileUpload.nativeElement.target.value="")})}fixUnknownLocations(){for(let n of this.events)if(n.unknownLocation){let e=localStorage[`match-camp-${n.unknownLocation}`],t=localStorage[`match-art-${n.unknownLocation}`],i=localStorage[`match-type-${n.unknownLocation}`];if(i=="camp")n.hosted_by_camp=parseInt(e),n.unknownLocation=void 0,n.other_location=void 0;else if(i=="art")n.located_at_art=t,n.unknownLocation=void 0,n.other_location=void 0;else if(i=="other")n.other_location=n.unknownLocation,n.hosted_by_camp=void 0,n.located_at_art=void 0;else if(e)n.hosted_by_camp=parseInt(e),n.unknownLocation=void 0;else{this.showSelectCamp=!0,this.unknownLocation=n.unknownLocation,this.eventInfo=`${n.title}. ${n.description}`,console.log("unknown location is",n.unknownLocation);return}}}isDuplicate(n,e){for(let t of e)if(t.occurrence_set==n.occurrence_set&&t.title==n.title&&t.description==n.description)return!0;return!1}import(){return S(this,null,function*(){this.busy=!0,this.title="Importing...";let n=0,e=0,t=this.events.length;for(;this.events.length>0;){let i;try{if(e++,i=this.events.pop(),i){let o=i.imageUrl;i.imageUrl=void 0,this.importing=i.title,this.progress=e/t;let r=yield this.api.addEvent(i);if(n++,o&&r.id){i.id=r.id;try{yield this.importImage(o,i)}catch{console.error(`Unable to import image for event ${i.title}: ${o}`)}}}}catch{console.error(`Failed to import ${i==null?void 0:i.title}: ${i==null?void 0:i.description}`)}}this.api.sendMessage(`Imported ${n} of ${e} events.`),this.busy=!1,this.api.clearCache(),this.location.back()})}isBlankLine(n){for(let e of Object.keys(n))if(n[e]&&n[e]!="")return!1;return!0}toUrl(n){let e=!1,t="";for(let i of n)if(i=="(")e=!0;else if(i==")")if(e=!1,t.length<3)t="";else return t;else e&&(t+=i);return t}importImage(n,e){return S(this,null,function*(){let t=this.toUrl(n),o=yield(yield fetch(t)).blob(),r=yield Pe(o,{quality:75,width:300});this.url=URL.createObjectURL(r),e.imageUrl=yield this.api.setImage(r,e.id),yield this.api.addEvent(e)})}importEvent(n,e){var D,x;let t={description:"",title:"",hosted_by_camp:void 0,occurrence_set:"[]",id:void 0,event_type:"Event",error:void 0,unknownLocation:void 0};t.title=n[e.title],t.description=n[e.description],t.event_type=n[e.event_type],t.event_type||(t.event_type=this.guessEventType(t.title,t.description)),t.event_type=="Yes"&&(t.event_type="Class/Workshop");let i=e.image,o=e.logo,r=e.startDay,l=e.endDay,g=e.start_time,_=e.end_time,m=n[e.location],v,h=!1;for(let u of this.camps)u.name.toLowerCase()=="unknown"&&(v=u),(m==null?void 0:m.toLowerCase().trim())==((D=u.name)==null?void 0:D.toLowerCase().trim())&&(t.hosted_by_camp=u.id,h=!0);let L=localStorage[`match-camp-${m}`],M=localStorage[`match-art-${m}`],W=localStorage[`match-type-${m}`];h||(L&&!t.hosted_by_camp?(t.hosted_by_camp=parseInt(L),h=!0):M&&!t.located_at_art&&(t.located_at_art=M,h=!0)),W=="other"&&(t.other_location=m,h=!0),h||(this.errors.push(`Location of event ${t.title} has an unknown location "${m}"`),t.error=`Unknown Location "${m}"`,t.unknownLocation=m,t.hosted_by_camp=v?v.id:void 0),i&&(t.imageUrl=n[i]),o&&this.isBlank(t.imageUrl)&&(t.imageUrl=n[o]);try{let u=this.multiOccurenceSet(n[r],n[l],n[g],n[_]);if(u.length>=1){let We=new Date(u[0].start_time),Fe=new Date(u[0].end_time);t.timeString=(x=Se(We,Fe,void 0,this.api.currentTimeZone()))==null?void 0:x.long}t.occurrence_set=JSON.stringify(u)}catch(u){this.errors.push(`There is an error with the event ${t.title}: ${u}`),t.error=`${u}`,console.error(u)}return t}multiOccurenceSet(n,e,t,i){let o=this.multiDay(n),r=[];for(let l of o){let g=this.convertToOccurrenceSet(l,e,t,i);(g.start_time.includes("NaN")||g.end_time.includes("NaN"))&&this.errors.push("The event times are invalid"),r.push(g)}return r}multiDay(n){let e=/\b(?:Mon(?:day)?|Tue(?:sday)?|Wed(?:nesday)?|Thu(?:rsday)?|Fri(?:day)?|Sat(?:urday)?|Sun(?:day)?),\s+[A-Z][a-z]+\s+\d{1,2}(?:st|nd|rd|th)?/g;return n.match(e)||[n]}guessEventType(n,e){let t=n?n.toLowerCase().trim():"",i=e?e.toLowerCase().trim():"",o={yoga:"Yoga/Movement/Fitness",class:"Class/Workshop",workshop:"Class/Workshop",conversation:"Class/Workshop",101:"Class/Workshop","learn to":"Class/Workshop","talk about":"Class/Workshop",relax:"Self Care","to play":"Games",films:"Performance","make a":"Arts & Crafts",meditation:"Ritual/Ceremony",ceremony:"Ritual/Ceremony",live:"Live Music",tasting:"Food/Drink",shibari:"Class/Workshop",karaoke:"Performance","happy hour":"Food/Drink",party:"Gathering/Party",spins:"Gathering/Party",djs:"Gathering/Party",dancing:"Gathering/Party",dance:"Gathering/Party",music:"Gathering/Party",movie:"Performance",pizza:"Food/Drink","fire spin":"Fire/Spectacle",session:"Class/Workshop",beginners:"Class/Workshop","safety meeting":"Class/Workshop",dungeon:"Mature Audiences",sex:"Mature Audiences",orgy:"Mature Audiences",tea:"Food/Drink",games:"Games","photo booth":"Games",cacao:"Food/Drink","bloody mary":"Food/Drink",homebrew:"Food/Drink","bring your cup":"Food/Drink",cookies:"Food/Drink",eating:"Food/Drink","drum circle":"Live Music",perform:"Performance",stroll:"Parade",acoustic:"Live Music","bar crawl":"Parade"};for(let r of Object.keys(o))if(t.includes(r)||i.includes(r))return o[r];return"Miscellaneous"}convertToOccurrenceSet(n,e,t,i){var l;if(n=(l=j(n,'"',""))==null?void 0:l.trim(),e=j(e,'"',""),e||(e=n),t.length>=19&&i.length>=19)return{start_time:t,end_time:i};t==""&&i==""&&(t="00:00am",i="11:59:59pm"),z(":",t)==2&&(t=t.replace(":00 ","")),z(":",i)==2&&(i=i.replace(":00 ",""));let o=this.toISODate(n+" "+t,void 0),r=this.toISODate(e+" "+i,o);return{start_time:o,end_time:r}}toIsoDateSlash(n,e){let t=n.split(" "),i=new Date(t[0]).toISOString().split("T")[0].split("-"),o=parseInt(i[0],10),r=parseInt(i[1],10)-1,l=parseInt(i[2],10),g=t[1].split(":"),_=parseInt(g[0],10),m=parseInt(g[1],10);n.toLowerCase().includes("pm")&&_!=12&&(_+=12);let v=O(o,r,l,_,m).replace("Z","");return e&&new Date(v).getTime()-new Date(e).getTime()<0&&(l=l+1,l>this.daysInMonth(r,o)&&(l=1,r++,r>12&&(r=0,o++)),v=O(o,r,l,_,m).replace("Z","")),v}toISODate(n,e){if(n.includes(" AM")&&(n=n.replace(" AM","am")),n.includes(" PM")&&(n=n.replace(" PM","pm")),n.includes("/"))return this.toIsoDateSlash(n,e);let t=n.split(" "),i,o=ke(void 0,"short"),r,l,g=0;for(let h of t){let L=Number.parseInt(h,10);!Number.isNaN(L)&&!i&&(i=L);let M=o.find(x=>h.toLowerCase().startsWith(x.toLowerCase()));M&&(r=M),h.toLowerCase()=="midnight"&&(l=23,g=59);let W=h.toLowerCase().endsWith("pm"),D=h.toLowerCase().endsWith("am");if(D||W||h.includes(":")){let x=h.toLowerCase().replace("pm","").replace("am","");if(x.includes(":")){let u=x.split(":");x=u[0],g=Number.parseInt(u[1])}l=Number.parseInt(x),W&&l<=11&&(l+=12),D&&l==12&&(l=0)}}if(l==null)throw new Error(`'${n}' is missing the time`);if(r==null)throw new Error(`'${n}' is missing the month`);if(i==null)throw new Error(`'${n}' is missing the day`);let _=o.indexOf(r),m=new Date().getFullYear(),v=O(m,_,i,l,g).replace("Z","");return e&&new Date(v).getTime()-new Date(e).getTime()<0&&(i=i+1,i>this.daysInMonth(_,m)&&(i=1,_++,_>12&&(_=0,m++)),v=O(m,_,i,l,g).replace("Z","")),v}daysInMonth(n,e){return new Date(e,n+1,0).getDate()}isBlank(n){return!n||n.trim()==""}mapColumns(n){if(n.length==0)return;let e=n[0],t={title:"",description:"",event_type:"",hosted_by_camp:void 0,occurrence_set:"",id:void 0};for(let i of Object.keys(e)){let o=i.toLowerCase();o.includes("event name")&&(t.title=i),o.includes("name")&&!o.includes("camp name")&&(t.title=i),o.includes("title")&&(t.title=i),o.includes("description")&&(t.description=i),o.includes("day")&&!t.startDay&&(t.startDay=i),o.includes("date")&&!t.startDay&&(t.startDay=i),o.includes("start date")&&(t.startDay=i),o.includes("end date")&&(t.endDay=i),o.includes("image")&&(t.image=i),o.includes("logo")&&(t.logo=i),o.includes("type")&&(t.event_type=i),(o.includes("start time")||o.includes("starttime"))&&(t.start_time=i),(o.includes("end time")||o.includes("endtime"))&&(t.end_time=i),o.includes("location")&&(t.location=i)}return t}};P.\u0275fac=function(e){return new(e||P)},P.\u0275cmp=Q({type:P,selectors:[["app-import-events"]],viewQuery:function(e,t){if(e&1&&H($e,7),e&2){let i;J(i=K())&&(t.fileUpload=i.first)}},decls:14,vars:5,consts:[["fileUpload",""],["color","primary"],["slot","start"],["routerLink","../"],[3,"fullscreen"],[3,"isOpen"],[1,"border"],["type","file",1,"file-input",3,"change"],["title","Complete Import",3,"press","hidden"],[1,"ion-padding"],[3,"ngModelChange","ngModel"],["labelPlacement","end","value","camp"],["label"," ","interface","popover","placeholder","Select camp for event",3,"ionChange","ngModelChange","value","ngModel"],[3,"value"],["labelPlacement","end","value","art"],["label"," ","interface","popover","placeholder","Select art for event",3,"ionChange","ngModelChange","value","ngModel"],["labelPlacement","end","value","other"],[1,"ion-text-center","ion-padding"],[3,"click"],[1,"ion-text-center","vcenter"],[2,"border-radius","2rem",3,"src"],[1,"ion-text-center"],[1,"error","ion-padding-left","ion-padding-right"],["lines","none"],["mode","ios"],[1,"error"]],template:function(e,t){if(e&1){let i=V();c(0,"ion-header")(1,"ion-toolbar",1)(2,"ion-buttons",2),E(3,"ion-back-button"),s(),c(4,"ion-title",3),p(5),s()()(),c(6,"ion-content",4)(7,"ion-modal",5),Y(8,Ue,25,7,"ng-template"),s(),k(9,Be,6,3)(10,Ye,3,2,"div",6),c(11,"input",7,0),b("change",function(r){return y(i),C(t.onFileSelected(r))}),s(),c(13,"app-footer",8),b("press",function(){return y(i),C(t.import())}),s()()}e&2&&(d(5),I(t.title),d(),w("fullscreen",!0),d(),w("isOpen",t.showSelectCamp),d(2),T(t.busy?9:10),d(4),w("hidden",t.busy||t.events.length===0))},dependencies:[xe,Ee,ae,pe,de,me,ue,ce,re,ge,_e,Ce,ve,se,le,fe,he,we,Ie,ie,te,ne,Le,Me,oe,ye,be],styles:[".error[_ngcontent-%COMP%]{color:red;font-weight:700}ion-card-title[_ngcontent-%COMP%]{font-size:var(--fs3)!important}ion-card-subtitle[_ngcontent-%COMP%]{font-size:var(--fs4)}ion-card-content[_ngcontent-%COMP%]{font-size:var(--fs4)}ion-select[_ngcontent-%COMP%]{width:50%;margin-left:50%}ion-radio[_ngcontent-%COMP%]{float:left;margin-top:.5rem}"]});var Oe=P;export{Oe as ImportEventsPage};
