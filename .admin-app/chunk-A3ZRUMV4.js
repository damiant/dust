import{a as J}from"./chunk-QTBNLBDF.js";import{a as H}from"./chunk-OF25KEPG.js";import{a as G}from"./chunk-55PDQDPP.js";import{w as z}from"./chunk-A5NTSXZY.js";import{$ as b,A as h,Aa as d,B as _,Ba as g,Lb as L,P as C,Qb as R,Rb as B,S as a,Sa as T,T as I,X as w,Xa as V,Yb as F,cc as O,da as p,dc as j,ec as M,fc as Q,ga as A,hc as D,ia as S,ja as U,ka as o,la as c,ma as u,mc as q,nc as N,oa as x,oc as W,pa as v,qa as y,sb as $,wa as k,xa as P,ya as E}from"./chunk-SLKJQVFW.js";import"./chunk-35XJAIHY.js";import"./chunk-7KGURMOZ.js";import"./chunk-W5R2B4OG.js";import"./chunk-SDKY465T.js";import"./chunk-45ASMX5N.js";import"./chunk-KM5AR3OJ.js";import"./chunk-XCRBEL2Y.js";import"./chunk-4U6PRYVA.js";import"./chunk-HJX2WMCX.js";import"./chunk-Z4V4M3ZT.js";import"./chunk-QPVVTFFW.js";import"./chunk-J6ICYO4L.js";import"./chunk-LF5XB4YN.js";import{h as m}from"./chunk-LNJ3S2LQ.js";var Y=["fileUpload"],Z=(s,n)=>n.name;function tt(s,n){if(s&1&&(u(0,"ion-progress-bar",9),o(1,"ion-text"),d(2),c(),u(3,"app-spinner"),o(4,"div",10),u(5,"img",11),c()),s&2){let t=y();p("value",t.progress),a(2),g(t.importing),a(3),p("src",t.url,C)}}function et(s,n){if(s&1){let t=x();o(0,"div",12)(1,"ion-button",13),v("click",function(){h(t);let i=y(2);return _(i.doImport())}),d(2,"Import from CSV"),c()()}}function it(s,n){if(s&1&&(o(0,"ion-item")(1,"ion-label")(2,"h3"),d(3),c(),o(4,"p"),d(5),c()()()),s&2){let t=n.$implicit;a(3),g(t.name),a(2),g(t.description)}}function nt(s,n){if(s&1&&(o(0,"div",7),b(1,et,3,0,"div",12),o(2,"ion-list"),S(3,it,6,2,"ion-item",null,Z),c()()),s&2){let t=y();a(),A(t.isSafari&&t.art.length===0?1:-1),a(2),U(t.art)}}var f=class f{constructor(n,t){this.api=n;this.location=t;this.vanity="";this.isAdmin=!1;this.busy=!1;this.art=[];this.title="Import Art";this.importing="";this.progress=0;this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);this.url=""}ngOnInit(){this.isAdmin=this.api.lastRoleResponse=="festival",this.isAdmin&&this.fileUpload.nativeElement.click()}doImport(){this.fileUpload.nativeElement.click()}onFileSelected(n){return m(this,null,function*(){let t=n.target.files[0];if(!t)return;let e=new FileReader;e.onload=i=>m(this,null,function*(){var l;let r=(l=i.target)==null?void 0:l.result;yield this.parseCSV(r);try{this.fileUpload.nativeElement.target&&(this.fileUpload.nativeElement.target.value="")}catch(X){console.info(X)}}),e.readAsText(t)})}parseCSV(n){return m(this,null,function*(){let t=J(n);console.info(t),this.art=[];let e=this.mapColumns(t);if(e){for(let i of t){let r=yield this.importArt(i,e);!!r.name&&this.art.push(r)}this.art=this.art.sort((i,r)=>i.name>r.name?1:-1),this.title=`Import ${this.art.length} art items`}})}import(){return m(this,null,function*(){this.busy=!0,this.title="Importing...";let n=0,t=0,e=this.art.length;for(;this.art.length>0;){let i;try{if(t++,i=this.art.pop(),i){let r=i.imageUrl;i.imageUrl=void 0,this.importing=i.name,this.progress=t/e;let l=yield this.api.addArt(i);if(n++,r&&l.id){i.id=l.id;try{yield this.importImage(r,i)}catch{console.error(`Unable to import image for art ${i.name}: ${r}`)}}}}catch{console.error(`Failed to import ${i==null?void 0:i.name}: ${i==null?void 0:i.description}`)}}this.api.sendMessage(`Imported ${n} of ${t} art items.`),this.busy=!1,this.api.clearCache(),this.location.back()})}toUrl(n){let t=!1,e="";for(let i of n)if(i=="(")t=!0;else if(i==")")if(t=!1,e.length<3)e="";else return e;else t&&(e+=i);return e}importImage(n,t){return m(this,null,function*(){let e=this.toUrl(n),r=yield(yield fetch(e)).blob(),l=yield H(r,{quality:75,width:300});this.url=URL.createObjectURL(l),t.imageUrl=yield this.api.setImage(l,t.id),yield this.api.addArt(t)})}mapColumns(n){if(n.length==0)return;let t=n[0],e={pin:"",name:"",category:"",id:void 0,art_type:"Art"};for(let i of Object.keys(t)){let r=i.toLowerCase();r.includes("name")&&!e.name&&!r.includes("artist name")&&(e.name=i),r.includes("art project")&&!e.name&&(e.name=i),r.includes("description")&&(e.description=i),r.includes("type")&&(e.art_type=i),(r.includes("web")||r.includes("url"))&&(e.url=i),r.includes("image")&&(e.image=i),r.includes("logo")&&(e.logo=i),r.includes("artist")&&(e.artist=i),r.includes("email")&&(e.contact_email=i),(r.includes("#")||r=="id")&&(e.externalId=i)}return console.log("map",e),e}importArt(n,t){return m(this,null,function*(){let e=yield this.api.getArt(void 0);e.name=n[t.name],t.description?e.description=n[t.description]:e.description=`Details on ${e.name} coming soon...`,t.externalId&&(e.externalId=n[t.externalId]),t.artist&&(e.artist=n[t.artist]),t.url&&(e.url=n[t.url]),t.art_type&&(e.art_type=n[t.art_type]),t.contact_email&&(e.contact_email=n[t.contact_email]);let i=t.image,r=t.logo;return i&&(e.imageUrl=n[i]),r&&this.isBlank(e.imageUrl)&&(e.imageUrl=n[r]),e})}isBlank(n){return!n||n.trim()==""}};f.\u0275fac=function(t){return new(t||f)(I(z),I(T))},f.\u0275cmp=w({type:f,selectors:[["app-import-art"]],viewQuery:function(t,e){if(t&1&&k(Y,7),t&2){let i;P(i=E())&&(e.fileUpload=i.first)}},inputs:{vanity:"vanity"},decls:14,vars:5,consts:[["fileUpload",""],["color","primary"],["slot","start"],["routerLink","../"],["slot","end",3,"hidden"],[3,"click","disabled"],[3,"fullscreen"],[1,"border"],["type","file",1,"file-input",3,"change"],[3,"value"],[1,"ion-text-center","vcenter"],[2,"border-radius","2rem",3,"src"],[1,"ion-text-center"],[3,"click"]],template:function(t,e){if(t&1){let i=x();o(0,"ion-header")(1,"ion-toolbar",1)(2,"ion-buttons",2),u(3,"ion-back-button"),c(),o(4,"ion-title",3),d(5),c(),o(6,"ion-buttons",4)(7,"ion-button",5),v("click",function(){return h(i),_(e.import())}),d(8,"Import"),c()()()(),o(9,"ion-content",6),b(10,tt,6,3)(11,nt,5,1,"div",7),o(12,"input",8,0),v("change",function(l){return h(i),_(e.onFileSelected(l))}),c()()}t&2&&(a(5),g(e.title),a(),p("hidden",e.art.length===0),a(),p("disabled",e.busy),a(2),p("fullscreen",!0),a(),A(e.busy?10:11))},dependencies:[D,q,R,Q,M,j,L,B,F,O,N,W,V,$,G],encapsulation:2});var K=f;export{K as ImportArtPage};
