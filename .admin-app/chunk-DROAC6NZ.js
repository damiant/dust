import{a as w}from"./chunk-MIGJGGKJ.js";import{L as c,s as f,w as P}from"./chunk-JQETABDO.js";import{h as s}from"./chunk-LNJ3S2LQ.js";function D(n,e,t,i){let r=t&&I(n,t),a=t&&I(e,t);if(!t||r||a){let d=n.toLocaleDateString([],{weekday:"long"}),o=a&&!r?`Until ${h(e,i)} (${y(e,n)})`:`${h(n,i)} (${y(e,n)})`,b=`${h(n,i)}`,p=`${d} ${h(n,i)}-${h(e,i)} (${y(e,n)})`;return p.endsWith("(24hrs)")&&(p=`${d} - All Day`),{long:p,short:o,brief:b}}}function C(n){let e=new Date(n);return!isNaN(e.getTime())}function $(n,e){return n===null||!n?e:n}function E(n){return!!String(n).toLowerCase().match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|.(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)}function L(n){return!n||n.trim()==""}function O(n){return new Promise(e=>setTimeout(e,n))}function _(n,e){return(e.match(new RegExp(n,"g"))||[]).length}function U(n){if(!n)return"";let e=n.split("@");return e.length==3?e[1]:e.length==2?e[0]:""}function N(n){let e=new Date(n);return Math.ceil((e.getTime()-new Date().getTime())/(1e3*60*60*24))}function W(n){if(!n)return"";let e=n.split("@");return e.length==3?e[2]:e.length==2?e[1]:""}function A(n){if(!(n=="new"||!n))return parseInt(n,10)}function l(n,e){let t=""+n;for(;t.length<e;)t="0"+t;return t}function Z(n){n.endsWith("Z")||(n=n+"Z");let e=n.split(/\D+/);return new Date(Date.UTC(e[0],--e[1],e[2],e[3],e[4],e[5],e[6]))}function z(n){let e=n.split(/[-:.T]/),t={year:g(e[0]),month:g(e[1]),day:g(e[2]),hour:g(e[3]),min:g(e[4])};return new Date(t.year,t.month-1,t.day,t.hour,t.min)}function g(n){return parseInt(n,10)}function B(n,e){return n.setTime(n.getTime()+e*60*60*1e3),n}function V(n,e){return n.setTime(n.getTime()+e*60*1e3),n}function j(n){return n.toISOString().replace(".000Z","")}function J(n){return n?(n.toUpperCase()==n&&n.length>5&&(n=n.toLowerCase().replace(/^\S|\.\s*\S/g,e=>e.toUpperCase())),n):""}function G(n,e,t,i,r){return`${l(n,4)}-${l(e+1,2)}-${l(t,2)}T${l(i,2)}:${l(r,2)}:00.000Z`}function Y(n){return n.endsWith("Z")?n.replace("Z",""):n}function H(n){let e=M(n);return(e<0?"+":"-")+l(parseInt(Math.abs(e/60)),2)+l(Math.abs(e%60),2)}function M(n){let e=new Date,t=new Date(e.toLocaleString("en-US",{timeZone:"UTC"}));return(new Date(e.toLocaleString("en-US",{timeZone:n}))-t)/(60*1e3)}function K(n){for(let[e,t]of Object.entries(n))(typeof t=="string"||t instanceof String)&&t&&t!==t.trim()&&(console.info(`${e} was trimmed of extra spaces.`),n[e]=t.trim())}var q=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],Q=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];function h(n,e){let t=n.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",timeZone:e}).toLowerCase().replace(" ","").replace(":00","");return t=="12am"?"Midnight":t=="12pm"?"Noon":t}function X(n,e){return n.toLocaleTimeString([],{hour12:!1,hour:"2-digit",minute:"2-digit",timeZone:e}).toLowerCase()}function I(n,e){return n.getDate()===e.getDate()&&n.getMonth()===e.getMonth()&&n.getFullYear()===e.getFullYear()}function ee(n,e="long"){let t=new Date().getFullYear(),i=[...Array(12).keys()],r=new Intl.DateTimeFormat(n,{month:e}),a=d=>r.format(new Date(t,d));return i.map(a)}function te(n){return new Promise((e,t)=>{try{let i=new FileReader;i.onloadend=()=>{let r=i.result;r?e(r):t()},i.onerror=t,i.readAsDataURL(n)}catch(i){t(i)}})}function y(n,e){let t=Math.ceil(Math.abs(n-e)/36e5),i=Math.floor(Math.abs(n-e)/1e3/60);return i<60?`${i}mins`:`${t}hrs`}function F(n){let e=n.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Illegal base64url string!"}return decodeURIComponent(window.escape(window.atob(e)))}function R(n=""){if(n===null||n==="")return{upn:""};let e=n.split(".");if(e.length!==3)throw new Error("JWT must have 3 parts");let t=F(e[1]);if(!t)throw new Error("Cannot decode the token");return JSON.parse(t)}function T(n){return n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function ne(n,e,t){return n&&n.replace(new RegExp(T(e),"g"),t)}function se(n){return n.replace(/\n([a-z])/g," $1")}var u=class u{constructor(){this.mem={}}get(e){return this.mem[e]?this.mem[e]:localStorage[this.key(e)]}key(e){return e=="token"?e:`admin-${e}`}set(e,t){t==null&&(delete this.mem[e],localStorage.removeItem(e.toString())),this.mem[e]=t,localStorage[this.key(e)]=t}clear(){this.mem={},localStorage.clear()}};u.\u0275fac=function(t){return new(t||u)},u.\u0275prov=f({token:u,factory:u.\u0275fac,providedIn:"root"});var v=u;var x=8787;var m=class m{constructor(){this.lastRoleResponse=null;this.changesMade=!1;this.user=c("");this.moreButton=c({buttons:[],event:void 0,hideProfile:!1});this.campRegistration=c(!1);this.campEditing=c(!1);this.eventEditing=c(!1);this.artEditing=c(!1);this.errorStream=c({status:200,text:"",url:""});this.messageStream=c({id:0,message:"",type:0});this.store=P(v);this.initialized=!1;this.cache={}}get festivalId(){return this.store.get("festivalId")}isLocal(){return location.protocol==="capacitor:"?!1:location.href.includes("localhost:")||location.href.includes("ngrok")}init(){console.log("initialized"),this.initialized=!0}checkInit(){if(!this.initialized){if(!w.isNativePlatform()){this.initialized=!0;return}console.warn("restarting..."),document.location.href="./index.html"}}url(e){return location.hostname,this.isLocal()?`http://${location.hostname}:${x}/${e}`:`https://api.dust.events/${e}`}imageURL(e){return e=="null"?"":this.isLocal()?e?`http://localhost:${x}/images/${e}`:"":e?`https://data.dust.events/${e}`:""}setFestival(e){this.campRegistration.set(e.camp_registration),this.campEditing.set(e.camp_editing),this.eventEditing.set(e.event_editing),this.artEditing.set(e.art_editing),this.store.set("festivalId",e.id),this.store.set("festivalTitle",e.name),this.store.set("festivalVanity",e.vanity),this.store.set("festivalImage",e.imageUrl),this.store.set("festivalTimeZone",e.timezone)}archive(e){return s(this,null,function*(){return yield this.post(`festivals/${e.vanity}/archive`,e)})}approve(e){return s(this,null,function*(){return yield this.post(`festivals/${e.vanity}/approve`,{})})}setEventTypes(e){return s(this,null,function*(){return yield this.post(`festivals/${e.vanity}/event-types`,e)})}setMessageSettings(e){return s(this,null,function*(){return yield this.post(`festivals/${e.festival_vanity}/message-settings`,e)})}setVolunteeripateSettings(e,t){return s(this,null,function*(){return yield this.post(`festivals/${e}/volunteeripate-settings`,t)})}vanity(){return this.store.get("festivalVanity")}produceError(e,t,i){this.errorStream.set({status:e,text:t,url:i})}getFestivalByVanity(e,t=!1,i=!0){return s(this,null,function*(){return(yield this.get(`festivals/${e}?by=vanity&pending=${t}`,{cached:i})).data})}isAdmin(e){return this.getAccessInfo(e).hasAdmin}isCampOwner(e,t){return this.getAccessInfo(e).camps.includes(t)}isArtOwner(e,t){return t?this.getAccessInfo(e).art.includes(t):!1}isEventOwner(e){return s(this,null,function*(){return e?!!(yield this.get(`events/${e}`,{cached:!1})):!1})}setFestivalByVanity(e,t=!1){return s(this,null,function*(){let i=!this.festivalId;if(this.vanity()==e&&!t&&!i)return;let r=yield this.getFestivalByVanity(e);if(!r)throw new Error(`Festival ${e} not found`);this.setFestival(r)})}sendPushMessage(e){return s(this,null,function*(){return yield this.post("messages",e)})}getPushInformation(){return s(this,null,function*(){return yield this.get("pushtokens")})}festivalTitle(){return this.store.get("festivalTitle")}festivalImage(){return this.store.get("festivalImage")}festivalTimeZone(){return this.store.get("festivalTimeZone")}addEvent(e){return s(this,null,function*(){return this.changesMade=!0,this.post("events",e)})}addMusic(e,t){return s(this,null,function*(){return e.occurrences=JSON.stringify(t),this.changesMade=!0,this.post("music",e)})}addLink(e){return s(this,null,function*(){return this.post("links",e)})}generateMap(e,t){return s(this,null,function*(){return yield this.post("map/create",{style:e,zoom:t})})}sendMessage(e,t,i){let r=this.messageStream();this.messageStream.set({id:r.id++,message:e,type:t!=null?t:0,title:i})}getCamp(e){return s(this,null,function*(){if(!e)return this.emptyCamp();let t=yield this.camp(e);return t||this.emptyCamp()})}getArt(e){return s(this,null,function*(){if(!e)return this.emptyArt();let t=yield this.artItem(e);return t||this.emptyArt()})}broadcast(e,t){return s(this,null,function*(){yield this.post("live",{festivalId:this.festivalId,lng:t.coords.longitude,lat:t.coords.latitude,id:e.id})})}emptyCamp(){return{name:"",description:"",pin:"",id:void 0,contact_email:"",camp_type:""}}emptyArt(){return{name:"",description:"",pin:"",category:"Open Playa Art",id:void 0,contact_email:"",art_type:""}}addFestival(e){return s(this,null,function*(){return yield this.post("festivals",e)})}updateFestivalSettings(e){return s(this,null,function*(){return yield this.post("festivals/registration",e)})}getFestivals(e){return s(this,null,function*(){return(yield this.get(e?"festivals?details=false":"festivals")).data})}getFestival(e,t){return s(this,null,function*(){let i=e?yield this.festival(e,t):void 0;return i||{name:"",contact:"",vanity:"",admins:"",description:"",mastodon_handle:"",inbox_email:"",start_time:new Date().toISOString(),end_time:new Date().toISOString(),id:void 0,active:!1,timezone:this.currentTimeZone(),gpsLat:0,gpsLng:0,approved:!1,camp_registration:!1,event_registration:!1,event_editing:!1,camp_editing:!1,art_editing:!1,max_event_types:2,map_direction:0,directions:void 0,pin:void 0,archived:!1,unknown_dates:!1,event_types:"",region:"",website:"",volunteeripate_domain:"",volunteeripate_identifier:"",rss_feed:""}})}currentTimeZone(){return Intl.DateTimeFormat().resolvedOptions().timeZone}placeCamp(e,t){return s(this,null,function*(){return this.changesMade=!0,yield this.post("place",{id:e,pt:t})})}saveCSS(e){return s(this,null,function*(){return this.changesMade=!0,yield this.post("css",{css:e})})}getCSS(){return s(this,null,function*(){return yield this.get("css",{cached:!1,asText:!0})})}placeArt(e,t){return s(this,null,function*(){return this.changesMade=!0,yield this.post("place/art",{id:e,pt:t})})}placePins(e){return s(this,null,function*(){return this.changesMade=!0,yield this.post("pins",e)})}getPins(){return s(this,null,function*(){return(yield this.get("pins",{cached:!1})).data})}newEvent(){return s(this,null,function*(){let e=yield this.defaultCamp();return{description:"",title:"",hosted_by_camp:e?e.id:void 0,occurrence_set:"[]",id:void 0,event_type:"Event"}})}newMusic(){return s(this,null,function*(){var i;let e=yield this.defaultCamp();return{title:"",id:void 0,campId:e?e.id:void 0,occurrences:"[]",camp:(i=e==null?void 0:e.name)!=null?i:"",location:"",day:""}})}getLink(e){return s(this,null,function*(){let t=yield this.links();for(let i of t)if(i.id==e)return i;return{title:"",id:void 0,url:""}})}camps(e){return s(this,null,function*(){return(yield this.get("camps",e)).data.sort((i,r)=>i.name.localeCompare(r.name))})}art(e){return s(this,null,function*(){return(yield this.get("art",e)).data.sort((i,r)=>i.name.localeCompare(r.name))})}music(){return s(this,null,function*(){return(yield this.get("music")).data})}getMusic(e){return s(this,null,function*(){return(yield this.get(`music/${e}`)).data})}getUnpublishedChanges(){return s(this,null,function*(){return(yield this.get("publish",{cached:!1})).data})}camp(e){return s(this,null,function*(){return(yield this.get(`camps/${e}`)).data})}artItem(e){return s(this,null,function*(){return(yield this.get(`art/${e}`)).data})}festival(e,t){return s(this,null,function*(){return(yield this.get(`festivals/${e}`,t)).data})}defaultCamp(){return s(this,null,function*(){return(yield this.get("camp")).data})}events(e){return s(this,null,function*(){return(yield this.get("events",e)).data})}getEvent(e){return s(this,null,function*(){return(yield this.get(`events/${e}`)).data})}getRedirect(e){return s(this,null,function*(){let t=yield this.post("redirect",{code:e});console.log("getRedirect",t);let i=t.message.split("+");if(i)return this.store.set("token",i[0]),i[1]})}links(){return s(this,null,function*(){return(yield this.get("links")).data})}signIn(e){return s(this,null,function*(){return e=e.toLowerCase().trim(),yield this.post("signin",{email:e})})}deleteEvent(e){return s(this,null,function*(){return this.changesMade=!0,yield this.delete("events",{id:e})})}clearCamps(){return s(this,null,function*(){return this.changesMade=!0,yield this.delete("camps/locations",{})})}clearData(e){return s(this,null,function*(){return this.changesMade=!0,yield this.delete(e?"everything":"all",{})})}clearEvents(){return s(this,null,function*(){return this.changesMade=!0,yield this.delete("all/events",{})})}clearArtLocations(){return s(this,null,function*(){return this.changesMade=!0,yield this.delete("art/locations",{})})}clearPinLocations(){return s(this,null,function*(){return this.changesMade=!0,yield this.delete("pins/locations",{})})}deleteParty(e){return s(this,null,function*(){return this.changesMade=!0,yield this.delete("music",{id:e})})}deleteLink(e){return s(this,null,function*(){return this.changesMade=!0,yield this.delete("links",{id:e})})}verify(e){return s(this,null,function*(){let i=(yield this.post("verify",{code:e})).message;return i.length>0?(this.store.set("token",i),!0):!1})}publish(){return s(this,null,function*(){return yield this.post("publish",{})})}preview(){return s(this,null,function*(){return yield this.post("preview",{})})}setMap(e){return s(this,null,function*(){return yield this.post("map",{base64:e})})}setImage(e,t){return s(this,null,function*(){this.changesMade=!0;let i=yield fetch(this.url("images"),{method:"POST",headers:{"Content-Type":"text/plain","Festival-Id":this.festivalId?this.festivalId.toString():"","Image-Id":t.toString(),Authorization:this.bearer()},body:e}),r=yield i.text();if(i.status!==200)throw this.errorStream.set({status:i.status,text:"",url:this.url("images")}),new Error(r);return r})}getMap(){return s(this,null,function*(){return(yield this.get("map",{cached:!1})).data})}addCamp(e,t){return s(this,null,function*(){return this.changesMade=!0,yield this.post(t?"camps?import=true":"camps",e)})}addArt(e){return s(this,null,function*(){return this.changesMade=!0,yield this.post("art",e)})}inviteCamp(e){return s(this,null,function*(){return yield this.post("camps/invite",e)})}inviteArt(e){return s(this,null,function*(){return yield this.post("art/invite",e)})}deleteCamp(e){return s(this,null,function*(){return this.changesMade=!0,yield this.delete("camps",e)})}deleteArt(e){return s(this,null,function*(){return this.changesMade=!0,yield this.delete("art",e)})}handleNewItem(e,t){return e&&e.id&&!t.id&&(t.id=e.id,t.revision_id=1),e}clearToken(){this.store.set("token",void 0),this.store.clear()}getAccessInfo(e){let t=R(this.store.get("token"));return t.hasAdmin=!!(e&&t.festivals.includes(e)),t.hasCamps=t.hasAdmin||t.camps.length>0,t.hasFestivals=t.hasAdmin||t.festivals.length>0,t.hasMusic=t.hasAdmin||t.hasCamps||t.music.length>0,t.hasArt=t.hasAdmin||t.art.length>0,t.isEventRegistrationOpen=!1,t.hasEvents=t.hasAdmin,t.events&&t.events.length>0&&(t.hasEvents=!0),t.approver=["damiantarnawsky@gmail.com","damian@dust.events"].includes(t.email),t}signedIn(){let e=this.store.get("token");if(e&&e.length>0){let t=this.parseJwt(e);if(t.email)return this.user.set(t.email),!0}return!1}setRedirection(e){this.store.set("redirectionUrl",e)}setKey(){return s(this,null,function*(){let e=sessionStorage.getItem("key");e&&(yield this.post("one-time-key",{key:e}),sessionStorage.removeItem("key"))})}getRedirectionUrl(){let e=this.store.get("redirectionUrl");return new URLSearchParams(window.location.search).get("redirect"),e}parseJwt(e){let i=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(window.atob(i).split("").map(function(a){return"%"+("00"+a.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(r)}signOut(){this.store.set("token",void 0),this.store.clear()}bearer(){let e=this.store.get("token");return e?`bearer ${e}`:""}post(e,t){return s(this,null,function*(){return this.handleNewItem(yield this.do("POST",e,t),t)})}delete(e,t){return s(this,null,function*(){return this.do("DELETE",e,t)})}apiResponse(e,t){return s(this,null,function*(){this.lastRoleResponse=e.headers.get("Role");let i=e.headers.get("NewToken");return i&&i!==""&&(console.log("Token was refreshed"),this.store.set("token",i)),{message:t?"":yield e.text(),id:A(e.headers.get("Id")),role:e.headers.get("Role"),data:t?yield e.json():void 0}})}do(e,t,i,r){return s(this,null,function*(){let a=!1,d=e=="GET"&&!r;try{let o=yield fetch(this.url(t),{method:e,headers:{"Content-Type":"application/json","Festival-Id":this.festivalId?this.festivalId.toString():"",Authorization:this.bearer()},body:JSON.stringify(i)});if(o.status!=200){a=!0;let b=o.headers.get("Message");this.handleError(e,t,b,o.status);let p=yield o.text();throw new Error(p)}return this.apiResponse(o,d)}catch(o){throw a||this.handleError(e,t,`${o}`),new Error("API Failure")}})}handleError(e,t,i,r){if(`${i}`.startsWith("Festival-Id was not set")&&(r=2,t="all",i="You need to select an event."),console.error(`[error][app] "${i}"`),`${i}`=="code is invalid")throw new Error("code is invalid");this.errorStream.set({status:r||500,text:`${i}`,url:r!=2?this.url(t):t}),this.isLocal()&&console.error(`${e} ${this.url(t)} failed. Did you start up the cloudflare worker?`)}clearCache(){this.cache={}}get(e,t){return s(this,null,function*(){if(!t||!t.cached)return yield this.do("GET",e,void 0,t==null?void 0:t.asText);if(!this.cache[e]){let i=yield this.do("GET",e);return this.cache[e]=JSON.parse(JSON.stringify(i.data)),i}return{message:"",data:this.cache[e]}})}};m.\u0275fac=function(t){return new(t||m)},m.\u0275prov=f({token:m,factory:m.\u0275fac,providedIn:"root"});var S=m;export{D as a,C as b,$ as c,E as d,L as e,O as f,_ as g,U as h,N as i,W as j,A as k,Z as l,z as m,B as n,V as o,j as p,J as q,G as r,Y as s,H as t,K as u,q as v,Q as w,X as x,ee as y,te as z,ne as A,se as B,v as C,S as D};
