import{a as Oe}from"./chunk-QTBNLBDF.js";import{a as De}from"./chunk-VBSH35Y7.js";import{a as Le}from"./chunk-5CHPG7GP.js";import{a as Me}from"./chunk-TRRH6YG6.js";import{B as Te,E as z,H as Pe,a as ke,h as j,s as O}from"./chunk-5TGYAYRP.js";import"./chunk-XMQYHBKU.js";import{$ as w,Aa as R,Cc as Se,D as Z,G as d,I as N,L as Q,Lb as ae,Mb as se,P as Y,Qa as ee,Sb as le,Tb as ce,Ub as de,V as k,Va as te,Vb as pe,W as T,Wb as me,X as q,Xb as ue,Y as G,Yb as fe,Z as A,_ as F,_b as he,aa as c,ba as s,ca as E,ea as $,ec as ge,fa as b,fc as _e,ga as f,hc as ve,ib as ne,jc as ye,ka as H,la as J,lb as ie,ma as K,mc as Ce,oc as we,pc as Ie,qc as xe,s as y,sb as oe,t as C,ta as p,tb as re,ua as I,va as V,wa as X,ya as U,yc as Ee,za as B,zc as be}from"./chunk-LVKFIXIJ.js";import"./chunk-JORYF43P.js";import"./chunk-7KGURMOZ.js";import"./chunk-R7LHOHUY.js";import"./chunk-HUOLUIW7.js";import"./chunk-CCK7OWI7.js";import"./chunk-LIBYTRNP.js";import"./chunk-3MK77LPM.js";import"./chunk-4U6PRYVA.js";import"./chunk-CZ4AHVKD.js";import"./chunk-Z4V4M3ZT.js";import"./chunk-QPVVTFFW.js";import"./chunk-J6ICYO4L.js";import"./chunk-LF5XB4YN.js";import{h as S}from"./chunk-LNJ3S2LQ.js";var $e=["fileUpload"];function Ve(a,t){if(a&1&&(c(0,"ion-select-option",13),p(1),s()),a&2){let e=t.$implicit;w("value",e.id),d(),I(e.name)}}function Ue(a,t){if(a&1&&(c(0,"ion-select-option",13),p(1),s()),a&2){let e=t.$implicit;w("value",e.id),d(),I(e.name)}}function Be(a,t){if(a&1){let e=$();c(0,"ion-content",9)(1,"div",9)(2,"h1"),p(3,"Unknown Location"),s(),c(4,"p"),p(5),s(),c(6,"p"),p(7),s(),c(8,"ion-radio-group",10),R("ngModelChange",function(i){y(e);let o=f();return B(o.locationType,i)||(o.locationType=i),C(i)}),c(9,"ion-radio",11),p(10,"Camp"),s(),c(11,"ion-select",12),b("ionChange",function(){y(e);let i=f();return C(i.locationType="camp")}),R("ngModelChange",function(i){y(e);let o=f();return B(o.selectedCamp,i)||(o.selectedCamp=i),C(i)}),A(12,Ve,2,2,"ion-select-option",13,G),s(),c(14,"ion-radio",14),p(15,"Art"),s(),c(16,"ion-select",15),b("ionChange",function(){y(e);let i=f();return C(i.locationType="art")}),R("ngModelChange",function(i){y(e);let o=f();return B(o.selectedArt,i)||(o.selectedArt=i),C(i)}),A(17,Ue,2,2,"ion-select-option",13,G),s(),c(19,"ion-radio",16),p(20,"Open Camping / Other"),s(),E(21,"br"),s()()(),c(22,"ion-toolbar",17)(23,"ion-button",18),b("click",function(){y(e);let i=f();return C(i.applyTransform(i.selectedCamp,i.selectedArt,i.locationType,i.unknownLocation))}),p(24,"Apply"),s()()}if(a&2){let e=f();d(5),V('Choose the camp or art that matches the location "',e.unknownLocation,'"'),d(2),I(e.eventInfo),d(),U("ngModel",e.locationType),d(3),w("value",e.selectedCamp),U("ngModel",e.selectedCamp),d(),F(e.camps),d(4),w("value",e.selectedArt),U("ngModel",e.selectedArt),d(),F(e.art)}}function Re(a,t){if(a&1&&(E(0,"ion-progress-bar",13),c(1,"ion-text"),p(2),s(),E(3,"app-spinner"),c(4,"div",19),E(5,"img",20),s()),a&2){let e=f();w("value",e.progress),d(2),I(e.importing),d(3),w("src",e.url,Z)}}function Ne(a,t){if(a&1){let e=$();c(0,"div",21)(1,"ion-button",18),b("click",function(){y(e);let i=f(2);return C(i.doImport())}),p(2,"Import from CSV"),s()()}}function Ge(a,t){if(a&1&&(c(0,"p",22),p(1),s()),a&2){let e=f(3);d(),X("There are ",e.errors.length," problems found in the CSV. You can choose to import but it is preferable to fix the errors in red below before importing. ",e.otherErrors)}}function je(a,t){a&1&&(c(0,"p",22),p(1,'Click "Complete Import" to perform the import'),s())}function ze(a,t){if(a&1&&(c(0,"ion-card-subtitle",25),p(1),s()),a&2){let e=f().$implicit;d(),I(e.error)}}function Ze(a,t){var e;if(a&1&&(c(0,"ion-card-subtitle"),p(1),s()),a&2){let n=f().$implicit;d(),V("",(e=n.timeString)!=null?e:"BAD TIME"," ")}}function Qe(a,t){if(a&1&&(c(0,"ion-item",23)(1,"ion-card",24)(2,"ion-card-header")(3,"ion-card-title"),p(4),s(),k(5,ze,2,1,"ion-card-subtitle",25)(6,Ze,2,1,"ion-card-subtitle"),s(),c(7,"ion-card-content"),p(8),E(9,"br"),c(10,"b"),p(11),s()()()()),a&2){let e=t.$implicit;d(4),I(e.title),d(),T(!e.hosted_by_camp||e.error?5:6),d(3),I(e.description),d(3),I(e.event_type)}}function Ye(a,t){if(a&1&&(c(0,"ion-list")(1,"h1"),p(2),s(),k(3,Ge,2,2,"p",22)(4,je,2,0,"p",22),A(5,Qe,12,4,"ion-item",23,q),s()),a&2){let e=f(2);d(2),V("",e.events.length," Events can be imported"),d(),T(e.errors.length>0?3:4),d(2),F(e.events)}}function qe(a,t){if(a&1&&(c(0,"div",6),k(1,Ne,3,0,"div",21),k(2,Ye,7,2,"ion-list"),s()),a&2){let e=f();d(),T(e.isSafari&&e.events.length===0?1:-1),d(),T(e.events.length>0||e.errors.length>0?2:-1)}}var P=class P{constructor(t,e){this.api=t;this.location=e;this.busy=!1;this.isAdmin=!1;this.importing="";this.title="Import";this.otherErrors="";this.locationType="camp";this.progress=0;this.url="";this.events=[];this.camps=[];this.art=[];this.errors=[];this.showSelectCamp=!1;this.unknownLocation="";this.eventInfo="";this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}ngOnInit(){this.isAdmin=this.api.lastRoleResponse=="festival",this.isAdmin&&this.fileUpload.nativeElement.click()}doImport(){this.fileUpload.nativeElement.click()}onFileSelected(t){return S(this,null,function*(){let e=t.target.files[0];if(!e)return;let n=new FileReader;n.onload=i=>S(this,null,function*(){var r;let o=(r=i.target)==null?void 0:r.result;this.parseCSV(o)}),n.readAsText(e)})}applyTransform(t,e,n,i){this.showSelectCamp=!1,n=="other"&&(t=void 0,e=void 0),n=="art"&&(t=void 0),n=="camp"&&(e=void 0),i&&(localStorage.setItem(`match-camp-${i}`,t),localStorage.setItem(`match-art-${i}`,e),localStorage.setItem(`match-type-${i}`,n),setTimeout(()=>{this.fixUnknownLocations()},1e3))}parseCSV(t){return S(this,null,function*(){let e=Oe(t+`
`);this.events=[];let n=this.mapColumns(e);this.camps=yield this.api.camps({cached:!1}),this.art=yield this.api.art({cached:!1}),this.errors=[],this.otherErrors="";let i=yield this.api.events({cached:!1}),o=0;if(n){for(let r of e)if(this.isBlankLine(r))console.log("Ignored blank line");else{let l=this.importEvent(r,n);this.isDuplicate(l,i)?(l.error="This event already exists and wont be imported",o++):this.events.push(l)}this.events=this.events.sort((r,l)=>r.title>l.title?1:-1),this.title=`Import ${this.events.length} events`,o>0&&(this.otherErrors=` There are ${o} duplicate events already imported that will be skipped.`)}this.fixUnknownLocations(),this.fileUpload.nativeElement.target&&(this.fileUpload.nativeElement.target.value="")})}fixUnknownLocations(){for(let t of this.events)if(t.unknownLocation){let e=localStorage[`match-camp-${t.unknownLocation}`],n=localStorage[`match-art-${t.unknownLocation}`],i=localStorage[`match-type-${t.unknownLocation}`];if(i=="camp")t.hosted_by_camp=parseInt(e),t.unknownLocation=void 0,t.other_location=void 0;else if(i=="art")t.located_at_art=n,t.unknownLocation=void 0,t.other_location=void 0;else if(i=="other")t.other_location=t.unknownLocation,t.hosted_by_camp=void 0,t.located_at_art=void 0;else if(e)t.hosted_by_camp=parseInt(e),t.unknownLocation=void 0;else{this.showSelectCamp=!0,this.unknownLocation=t.unknownLocation,this.eventInfo=`${t.title}. ${t.description}`,console.log("unknown location is",t.unknownLocation);return}}}isDuplicate(t,e){for(let n of e)if(n.occurrence_set==t.occurrence_set&&n.title==t.title&&n.description==t.description)return!0;return!1}import(){return S(this,null,function*(){this.busy=!0,this.title="Importing...";let t=0,e=0,n=this.events.length;for(;this.events.length>0;){let i;try{if(e++,i=this.events.pop(),i){let o=i.imageUrl;i.imageUrl=void 0,this.importing=i.title,this.progress=e/n;let r=yield this.api.addEvent(i);if(t++,o&&r.id){i.id=r.id;try{yield this.importImage(o,i)}catch{console.error(`Unable to import image for event ${i.title}: ${o}`)}}}}catch{console.error(`Failed to import ${i==null?void 0:i.title}: ${i==null?void 0:i.description}`)}}this.api.sendMessage(`Imported ${t} of ${e} events.`),this.busy=!1,this.api.clearCache(),this.location.back()})}isBlankLine(t){for(let e of Object.keys(t))if(t[e]&&t[e]!="")return!1;return!0}toUrl(t){let e=!1,n="";for(let i of t)if(i=="(")e=!0;else if(i==")")if(e=!1,n.length<3)n="";else return n;else e&&(n+=i);return n}importImage(t,e){return S(this,null,function*(){let n=this.toUrl(t),o=yield(yield fetch(n)).blob(),r=yield Le(o,{quality:75,width:300});this.url=URL.createObjectURL(r),e.imageUrl=yield this.api.setImage(r,e.id),yield this.api.addEvent(e)})}importEvent(t,e){var D,x;let n={description:"",title:"",hosted_by_camp:void 0,occurrence_set:"[]",id:void 0,event_type:"Event",error:void 0,unknownLocation:void 0};n.title=t[e.title],n.description=t[e.description],n.event_type=t[e.event_type],n.event_type||(n.event_type=this.guessEventType(n.title,n.description)),n.event_type=="Yes"&&(n.event_type="Class/Workshop");let i=e.image,o=e.logo,r=e.startDay,l=e.endDay,g=e.start_time,_=e.end_time,m=t[e.location],v,h=!1;for(let u of this.camps)u.name.toLowerCase()=="unknown"&&(v=u),(m==null?void 0:m.toLowerCase().trim())==((D=u.name)==null?void 0:D.toLowerCase().trim())&&(n.hosted_by_camp=u.id,h=!0);let L=localStorage[`match-camp-${m}`],M=localStorage[`match-art-${m}`],W=localStorage[`match-type-${m}`];h||(L&&!n.hosted_by_camp?(n.hosted_by_camp=parseInt(L),h=!0):M&&!n.located_at_art&&(n.located_at_art=M,h=!0)),W=="other"&&(n.other_location=m,h=!0),h||(this.errors.push(`Location of event ${n.title} has an unknown location "${m}"`),n.error=`Unknown Location "${m}"`,n.unknownLocation=m,n.hosted_by_camp=v?v.id:void 0),i&&(n.imageUrl=t[i]),o&&this.isBlank(n.imageUrl)&&(n.imageUrl=t[o]);try{let u=this.multiOccurenceSet(t[r],t[l],t[g],t[_]);if(u.length>=1){let Ae=new Date(u[0].start_time),Fe=new Date(u[0].end_time);n.timeString=(x=ke(Ae,Fe,void 0,this.api.currentTimeZone()))==null?void 0:x.long}n.occurrence_set=JSON.stringify(u)}catch(u){this.errors.push(`There is an error with the event ${n.title}: ${u}`),n.error=`${u}`,console.error(u)}return n}multiOccurenceSet(t,e,n,i){let o=this.multiDay(t),r=[];for(let l of o){let g=this.convertToOccurrenceSet(l,e,n,i);(g.start_time.includes("NaN")||g.end_time.includes("NaN"))&&this.errors.push("The event times are invalid"),r.push(g)}return r}multiDay(t){let e=/\b(?:Mon(?:day)?|Tue(?:sday)?|Wed(?:nesday)?|Thu(?:rsday)?|Fri(?:day)?|Sat(?:urday)?|Sun(?:day)?),\s+[A-Z][a-z]+\s+\d{1,2}(?:st|nd|rd|th)?/g;return t.match(e)||[t]}guessEventType(t,e){let n=t?t.toLowerCase().trim():"",i=e?e.toLowerCase().trim():"",o={yoga:"Yoga/Movement/Fitness",class:"Class/Workshop",workshop:"Class/Workshop",conversation:"Class/Workshop",101:"Class/Workshop","learn to":"Class/Workshop","talk about":"Class/Workshop",relax:"Self Care","to play":"Games",films:"Performance","make a":"Arts & Crafts",meditation:"Ritual/Ceremony",ceremony:"Ritual/Ceremony",live:"Live Music",tasting:"Food/Drink",shibari:"Class/Workshop",karaoke:"Performance","happy hour":"Food/Drink",party:"Gathering/Party",spins:"Gathering/Party",djs:"Gathering/Party",dancing:"Gathering/Party",dance:"Gathering/Party",music:"Gathering/Party",movie:"Performance",pizza:"Food/Drink","fire spin":"Fire/Spectacle",session:"Class/Workshop",beginners:"Class/Workshop","safety meeting":"Class/Workshop",dungeon:"Mature Audiences",sex:"Mature Audiences",orgy:"Mature Audiences",tea:"Food/Drink",games:"Games","photo booth":"Games",cacao:"Food/Drink","bloody mary":"Food/Drink",homebrew:"Food/Drink","bring your cup":"Food/Drink",cookies:"Food/Drink",eating:"Food/Drink","drum circle":"Live Music",perform:"Performance",stroll:"Parade",acoustic:"Live Music","bar crawl":"Parade"};for(let r of Object.keys(o))if(n.includes(r)||i.includes(r))return o[r];return"Miscellaneous"}convertToOccurrenceSet(t,e,n,i){var l;if(t=(l=z(t,'"',""))==null?void 0:l.trim(),e=z(e,'"',""),e||(e=t),n.length>=19&&i.length>=19)return{start_time:n,end_time:i};n==""&&i==""&&(n="00:00am",i="11:59:59pm"),j(":",n)==2&&(n=n.replace(":00 ","")),j(":",i)==2&&(i=i.replace(":00 ",""));let o=this.toISODate(t+" "+n,void 0),r=this.toISODate(e+" "+i,o);return{start_time:o,end_time:r}}toIsoDateSlash(t,e){let n=t.split(" "),i=new Date(n[0]).toISOString().split("T")[0].split("-"),o=parseInt(i[0],10),r=parseInt(i[1],10)-1,l=parseInt(i[2],10),g=n[1].split(":"),_=parseInt(g[0],10),m=parseInt(g[1],10);t.toLowerCase().includes("pm")&&_!=12&&(_+=12);let v=O(o,r,l,_,m).replace("Z","");return e&&new Date(v).getTime()-new Date(e).getTime()<0&&(l=l+1,l>this.daysInMonth(r,o)&&(l=1,r++,r>12&&(r=0,o++)),v=O(o,r,l,_,m).replace("Z","")),v}toISODate(t,e){if(t.includes(" AM")&&(t=t.replace(" AM","am")),t.includes(" PM")&&(t=t.replace(" PM","pm")),t.includes("/"))return this.toIsoDateSlash(t,e);let n=t.split(" "),i,o=Te(void 0,"short"),r,l,g=0;for(let h of n){let L=Number.parseInt(h,10);!Number.isNaN(L)&&!i&&(i=L);let M=o.find(x=>h.toLowerCase().startsWith(x.toLowerCase()));M&&(r=M),h.toLowerCase()=="midnight"&&(l=23,g=59);let W=h.toLowerCase().endsWith("pm"),D=h.toLowerCase().endsWith("am");if(D||W||h.includes(":")){let x=h.toLowerCase().replace("pm","").replace("am","");if(x.includes(":")){let u=x.split(":");x=u[0],g=Number.parseInt(u[1])}l=Number.parseInt(x),W&&l<=11&&(l+=12),D&&l==12&&(l=0)}}if(l==null)throw new Error(`'${t}' is missing the time`);if(r==null)throw new Error(`'${t}' is missing the month`);if(i==null)throw new Error(`'${t}' is missing the day`);let _=o.indexOf(r),m=new Date().getFullYear(),v=O(m,_,i,l,g).replace("Z","");return e&&new Date(v).getTime()-new Date(e).getTime()<0&&(i=i+1,i>this.daysInMonth(_,m)&&(i=1,_++,_>12&&(_=0,m++)),v=O(m,_,i,l,g).replace("Z","")),v}daysInMonth(t,e){return new Date(e,t+1,0).getDate()}isBlank(t){return!t||t.trim()==""}mapColumns(t){if(t.length==0)return;let e=t[0],n={title:"",description:"",event_type:"",hosted_by_camp:void 0,occurrence_set:"",id:void 0};for(let i of Object.keys(e)){let o=i.toLowerCase();o.includes("event name")&&(n.title=i),o.includes("name")&&!o.includes("camp name")&&(n.title=i),o.includes("title")&&(n.title=i),o.includes("description")&&(n.description=i),o.includes("day")&&!n.startDay&&(n.startDay=i),o.includes("date")&&!n.startDay&&(n.startDay=i),o.includes("start date")&&(n.startDay=i),o.includes("end date")&&(n.endDay=i),o.includes("image")&&(n.image=i),o.includes("logo")&&(n.logo=i),o.includes("type")&&(n.event_type=i),(o.includes("start time")||o.includes("starttime"))&&(n.start_time=i),(o.includes("end time")||o.includes("endtime"))&&(n.end_time=i),o.includes("location")&&(n.location=i)}return n}};P.\u0275fac=function(e){return new(e||P)(N(Pe),N(ee))},P.\u0275cmp=Q({type:P,selectors:[["app-import-events"]],viewQuery:function(e,n){if(e&1&&H($e,7),e&2){let i;J(i=K())&&(n.fileUpload=i.first)}},decls:14,vars:5,consts:[["fileUpload",""],["color","primary"],["slot","start"],["routerLink","../"],[3,"fullscreen"],[3,"isOpen"],[1,"border"],["type","file",1,"file-input",3,"change"],["title","Complete Import",3,"press","hidden"],[1,"ion-padding"],[3,"ngModelChange","ngModel"],["labelPlacement","end","value","camp"],["label"," ","interface","popover","placeholder","Select camp for event",3,"ionChange","ngModelChange","value","ngModel"],[3,"value"],["labelPlacement","end","value","art"],["label"," ","interface","popover","placeholder","Select art for event",3,"ionChange","ngModelChange","value","ngModel"],["labelPlacement","end","value","other"],[1,"ion-text-center","ion-padding"],[3,"click"],[1,"ion-text-center","vcenter"],[2,"border-radius","2rem",3,"src"],[1,"ion-text-center"],[1,"error","ion-padding-left","ion-padding-right"],["lines","none"],["mode","ios"],[1,"error"]],template:function(e,n){if(e&1){let i=$();c(0,"ion-header")(1,"ion-toolbar",1)(2,"ion-buttons",2),E(3,"ion-back-button"),s(),c(4,"ion-title",3),p(5),s()()(),c(6,"ion-content",4)(7,"ion-modal",5),Y(8,Be,25,7,"ng-template"),s(),k(9,Re,6,3)(10,qe,3,2,"div",6),c(11,"input",7,0),b("change",function(r){return y(i),C(n.onFileSelected(r))}),s(),c(13,"app-footer",8),b("press",function(){return y(i),C(n.import())}),s()()}e&2&&(d(5),I(n.title),d(),w("fullscreen",!0),d(),w("isOpen",n.showSelectCamp),d(2),T(n.busy?9:10),d(4),w("hidden",n.busy||n.events.length===0))},dependencies:[Ee,be,se,me,pe,ue,fe,de,ae,_e,ve,we,ye,le,ce,he,ge,Ie,xe,te,oe,ne,ie,Me,De,re,Ce,Se],styles:[".error[_ngcontent-%COMP%]{color:red;font-weight:700}ion-card-title[_ngcontent-%COMP%]{font-size:var(--fs3)!important}ion-card-subtitle[_ngcontent-%COMP%]{font-size:var(--fs4)}ion-card-content[_ngcontent-%COMP%]{font-size:var(--fs4)}ion-select[_ngcontent-%COMP%]{width:50%;margin-left:50%}ion-radio[_ngcontent-%COMP%]{float:left;margin-top:.5rem}"]});var We=P;export{We as ImportEventsPage};
