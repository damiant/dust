import{K as X}from"./chunk-OQVFSD37.js";import"./chunk-PFLI22GG.js";import{$ as S,Aa as b,Ba as U,Ca as B,Db as N,E as C,Ec as A,Fc as J,G as k,H as o,P as E,Ua as M,Wb as $,X as v,Y as P,Za as L,_ as T,aa as V,ba as d,ca as s,cc as H,da as l,dc as Q,ea as x,gb as D,ja as _,jb as F,la as f,lc as W,na as g,p as u,pc as j,ra as I,rc as q,s as p,sa as R,t as c,ta as z,xa as w,za as O}from"./chunk-FDEJMFAU.js";import"./chunk-JORYF43P.js";import"./chunk-7KGURMOZ.js";import"./chunk-UT2PGJWE.js";import"./chunk-6Y2ASLSF.js";import"./chunk-XRJ4SE6F.js";import"./chunk-LIBYTRNP.js";import"./chunk-3MK77LPM.js";import"./chunk-4U6PRYVA.js";import"./chunk-CZ4AHVKD.js";import"./chunk-Z4V4M3ZT.js";import"./chunk-LLZYEWEK.js";import"./chunk-Z2GS73PT.js";import"./chunk-LF5XB4YN.js";import{h as y}from"./chunk-LNJ3S2LQ.js";var ee=["map"];function ie(r,i){if(r&1){let e=_();s(0,"div",12),f("click",function(){let n=p(e).$implicit,a=g();return c(a.select(n))}),s(1,"div",13),b(2),l()()}if(r&2){let e=i.$implicit;O(e.selected?"pin pin-select":"pin"),w("left",e.x+"px")("top",e.y+"px"),d("title",e.label),o(2),U(e.label)}}function te(r,i){if(r&1&&x(0,"div",14),r&2){let e=g();w("left",e.pin.x+"px")("top",e.pin.y+"px"),d("title",e.pin.label)}}function ne(r,i){if(r&1){let e=_();s(0,"ion-footer",11)(1,"ion-button",4),f("click",function(){p(e);let n=g();return c(n.removePin())}),b(2,"Remove Pin"),l()()}if(r&2){let e=g();o(),d("disabled",e.busy)}}var h=class h{constructor(){this.api=u(X);this.router=u(F);this.sanitizer=u(D);this.location=u(L);this.vanity=M();this.id=M();this.camp={name:"",description:"",pin:"",id:void 0,contact_email:"",camp_type:"",publicEvents:!1};this.mapUri="";this.pt={x:0,y:0};this.busy=!1;this.pins=[];this.camps=[]}ionViewWillEnter(){return y(this,null,function*(){yield this.api.setFestivalByVanity(this.vanity()),this.camp=yield this.api.getCamp(this.id());let i=yield this.api.getMap();i.base64?this.mapUri=this.sanitizer.bypassSecurityTrustUrl(i.base64):this.mapUri=this.api.imageURL(`${this.vanity()}/${i.filename}`),this.camps=yield this.api.camps({cached:!0})})}onResize(){this.pins=this.getPins(this.camps,this.camp)}onMapLoad(){this.pins=this.getPins(this.camps,this.camp)}select(i){this.selectedPin&&(this.selectedPin.selected=!1),i.selected=!0,this.camp=i.camp,this.selectedPin=i,console.log("Selected pin:",i)}mapPoint(i){let e=i.clientX,t=i.clientY,a=this.map.nativeElement.getBoundingClientRect(),m=(e-a.x)*1e4/a.width,G=(t-a.y)*1e4/a.height;this.pt={x:Math.ceil(m),y:Math.ceil(G)},this.pin={x:this.pt.x*this.width()/1e4,y:this.pt.y*this.height()/1e4,label:this.camp.name,pt:this.pt,changed:!0};let K=this.pin.x,Z=this.pin.y;return this.selectedPin&&(this.selectedPin.selected=!1,this.selectedPin.changed=!0,this.selectedPin.pt=this.pt),setTimeout(()=>{this.selectedPin&&(this.selectedPin.x=K,this.selectedPin.y=Z)},500),!1}width(){return this.map.nativeElement.getBoundingClientRect().width}height(){return this.map.nativeElement.getBoundingClientRect().height}getPins(i,e){let t=[];for(let n of i)if(n.pin&&n.pin.trim()!=""){let a=JSON.parse(n.pin),m=n.id===(e==null?void 0:e.id);t.push({x:a.x*this.width()/1e4,y:a.y*this.height()/1e4,label:n.name,camp:n,selected:m}),m&&(this.selectedPin=t[t.length-1])}return t}save(){return y(this,null,function*(){this.busy=!0;try{let i=0;for(let e of this.pins)if(e.changed){if(console.log(e),!e.pt){this.api.sendMessage(`Error: No position for ${e.camp.name}`,0,"Error"),this.busy=!1;return}this.api.sendMessage(`Saving ${e.camp.name}...`,1,"Saving"),yield this.api.placeCamp(e.camp.id,e.pt),i++}i||(yield this.api.placeCamp(this.id(),this.pt)),this.api.clearCache(),this.location.back(),this.location.back()}finally{this.busy=!1}})}removePin(){return y(this,null,function*(){this.busy=!0;try{yield this.api.placeCamp(this.id(),void 0),this.api.clearCache(),this.location.back()}finally{this.busy=!1}})}};h.\u0275fac=function(e){return new(e||h)},h.\u0275cmp=E({type:h,selectors:[["app-map"]],viewQuery:function(e,t){if(e&1&&I(ee,5),e&2){let n;R(n=z())&&(t.map=n.first)}},inputs:{vanity:[1,"vanity"],id:[1,"id"]},decls:18,vars:6,consts:[["map",""],["color","primary"],["slot","start"],["slot","end"],[3,"click","disabled"],[3,"fullscreen"],[1,"page2"],[1,"map"],[3,"title","left","top","class"],[1,"placed","pin",3,"title","left","top"],[3,"load","resize","click","src"],[1,"ion-padding","ion-text-center"],[3,"click","title"],[1,"label"],[1,"placed","pin",3,"title"]],template:function(e,t){if(e&1){let n=_();s(0,"ion-header")(1,"ion-toolbar",1)(2,"ion-buttons",2),x(3,"ion-back-button"),l(),s(4,"ion-title"),b(5),l(),s(6,"ion-buttons",3)(7,"ion-button",4),f("click",function(){return p(n),c(t.save())}),b(8,"Save"),l()()()(),s(9,"ion-content",5)(10,"div",6)(11,"div",7),S(12,ie,3,8,"div",8,T),v(14,te,1,5,"div",9),l(),s(15,"img",10,0),f("load",function(){return p(n),c(t.onMapLoad())})("resize",function(){return p(n),c(t.onResize())},k)("click",function(m){return p(n),c(t.mapPoint(m))}),l()()(),v(17,ne,3,1,"ion-footer",11)}e&2&&(o(5),B("Place ",t.camp.name," on Map"),o(2),d("disabled",t.busy),o(2),d("fullscreen",!0),o(3),V(t.pins),o(2),P(t.pin?14:-1),o(),d("src",t.mapUri,C),o(2),P(t.camp.pin&&t.camp.pin.length>0?17:-1))},dependencies:[j,N,q,J,Q,$,A,H,W],styles:["img[_ngcontent-%COMP%]{user-drag:none;user-select:none;-moz-user-select:none;-webkit-user-drag:none;-webkit-user-select:none;-ms-user-select:none}.placed[_ngcontent-%COMP%]{background-color:red!important;border:2px solid white!important;width:15px;height:15px;border-radius:var(--br-2xl)}.pin[_ngcontent-%COMP%]{width:10px;height:10px;border-radius:var(--br-xl);background-color:#fff;border:2px solid rgb(255,116,116);position:absolute}.pin-select[_ngcontent-%COMP%]{border:3px solid red!important}.pin[_ngcontent-%COMP%]   .label[_ngcontent-%COMP%]{visibility:hidden;width:200px;margin-left:var(--spacing-base);margin-top:calc(-1 * var(--spacing-xs));-webkit-text-stroke-width:4px;-webkit-text-stroke-color:rgba(0,0,0,.1);text-stroke-width:4px;text-stroke-color:rgba(0,0,0,.1);color:#fff;font-weight:700}.pin[_ngcontent-%COMP%]:hover   .label[_ngcontent-%COMP%]{visibility:visible}.map[_ngcontent-%COMP%]{position:absolute}"]});var Y=h;export{Y as MapPage};
