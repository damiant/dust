import{a as rt}from"./chunk-QTBNLBDF.js";import{a as it}from"./chunk-KCPLCCSF.js";import{a as nt}from"./chunk-GLPG6IXG.js";import{J as et}from"./chunk-2K4NO5ZT.js";import"./chunk-PFLI22GG.js";import{$ as P,Aa as g,Ba as y,Cb as j,Cc as Y,D as M,Dc as Z,Ec as tt,G as a,O as V,Ta as B,Vb as D,W as _,X as x,Ya as O,_ as E,aa as A,ac as N,ba as s,bc as Q,ca as l,cc as W,da as C,ia as k,ka as U,kc as z,ma as u,p as F,qa as R,qc as q,ra as L,rc as H,s as b,sa as $,sc as G,t as S,tc as J,uc as K,xc as X,za as c}from"./chunk-OCTOJKK3.js";import"./chunk-JORYF43P.js";import"./chunk-7KGURMOZ.js";import"./chunk-UT2PGJWE.js";import"./chunk-6Y2ASLSF.js";import"./chunk-XRJ4SE6F.js";import"./chunk-LIBYTRNP.js";import"./chunk-3MK77LPM.js";import"./chunk-4U6PRYVA.js";import"./chunk-CZ4AHVKD.js";import"./chunk-Z4V4M3ZT.js";import"./chunk-LLZYEWEK.js";import"./chunk-Z2GS73PT.js";import"./chunk-LF5XB4YN.js";import{h}from"./chunk-LNJ3S2LQ.js";function at(r,n){let t=["name","description","art_type","contact_email","artist","url","category","externalId"],e=[];for(let i of t){let o=ot(r[i]),m=ot(n[i]);o!==m&&e.push(i)}return e}function st(r,n){return n?at(r,n).length===0?"existing":"updated":"new"}function lt(r,n){return at(r,n)}function ot(r){return r==null?"":String(r).trim()}var pt=["fileUpload"],T=(r,n)=>n.art.name;function gt(r,n){if(r&1&&(C(0,"ion-progress-bar",9),s(1,"ion-text"),c(2),l(),C(3,"app-spinner"),s(4,"div",10),C(5,"img",11),l()),r&2){let t=u();A("value",t.progress),a(2),g(t.importing),a(3),A("src",t.url,M)}}function ut(r,n){if(r&1&&(s(0,"ion-item")(1,"ion-label")(2,"div",14)(3,"h3"),c(4),l(),s(5,"ion-badge",15),c(6,"New"),l()(),s(7,"p"),c(8),l()()()),r&2){let t=n.$implicit;a(4),g(t.art.name),a(4),g(t.art.description)}}function ft(r,n){if(r&1&&(s(0,"ion-item-divider")(1,"ion-label")(2,"h2"),c(3),l()()(),E(4,ut,9,2,"ion-item",null,T)),r&2){let t=u(2);a(3),y("New Art (",t.groupedArt.get("new").length,")"),a(),P(t.groupedArt.get("new"))}}function ht(r,n){if(r&1&&(s(0,"p",17),c(1),l()),r&2){let t=u().$implicit;a(),y("Changed: ",t.changedFields.join(", "))}}function _t(r,n){if(r&1&&(s(0,"ion-item")(1,"ion-label")(2,"div",14)(3,"h3"),c(4),l(),s(5,"ion-badge",16),c(6,"Updated"),l()(),s(7,"p"),c(8),l(),_(9,ht,2,1,"p",17),l()()),r&2){let t=n.$implicit;a(4),g(t.art.name),a(4),g(t.art.description),a(),x(t.changedFields&&t.changedFields.length>0?9:-1)}}function xt(r,n){if(r&1&&(s(0,"ion-item-divider")(1,"ion-label")(2,"h2"),c(3),l()()(),E(4,_t,10,3,"ion-item",null,T)),r&2){let t=u(2);a(3),y("Updated Art (",t.groupedArt.get("updated").length,")"),a(),P(t.groupedArt.get("updated"))}}function At(r,n){if(r&1&&(s(0,"ion-item")(1,"ion-label")(2,"div",14)(3,"h3"),c(4),l(),s(5,"ion-badge",18),c(6,"Existing"),l()(),s(7,"p"),c(8),l()()()),r&2){let t=n.$implicit;a(4),g(t.art.name),a(4),g(t.art.description)}}function It(r,n){if(r&1&&(s(0,"ion-item-divider")(1,"ion-label")(2,"h2"),c(3),l()()(),E(4,At,9,2,"ion-item",null,T)),r&2){let t=u(2);a(3),y("Existing Art (",t.groupedArt.get("existing").length,")"),a(),P(t.groupedArt.get("existing"))}}function vt(r,n){if(r&1){let t=k();s(0,"div",7)(1,"div",12)(2,"ion-button",13),U("click",function(){b(t);let i=u();return S(i.doImport())}),c(3,"Import from CSV"),l()(),s(4,"ion-list"),_(5,ft,6,1),_(6,xt,6,1),_(7,It,6,1),l()()}if(r&2){let t=u();a(5),x(t.groupedArt.get("new")&&t.groupedArt.get("new").length>0?5:-1),a(),x(t.groupedArt.get("updated")&&t.groupedArt.get("updated").length>0?6:-1),a(),x(t.groupedArt.get("existing")&&t.groupedArt.get("existing").length>0?7:-1)}}var I=class I{constructor(){this.api=F(et);this.location=F(O);this.vanity=B("");this.isAdmin=!1;this.busy=!1;this.art=[];this.artWithIds=new Map;this.groupedArt=new Map;this.title="Import Art";this.importing="";this.progress=0;this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);this.url=""}ngOnInit(){this.isAdmin=this.api.lastRoleResponse=="festival",this.isAdmin&&this.fileUpload.nativeElement.click()}doImport(){this.fileUpload.nativeElement.click()}onFileSelected(n){return h(this,null,function*(){let t=n.target.files[0];if(!t)return;let e=new FileReader;e.onload=i=>h(this,null,function*(){var m;let o=(m=i.target)==null?void 0:m.result;yield this.parseCSV(o);try{this.fileUpload.nativeElement.target&&(this.fileUpload.nativeElement.target.value="")}catch(f){console.info(f)}}),e.readAsText(t)})}parseCSV(n){return h(this,null,function*(){let t=rt(n);console.info(t),this.art=[],this.groupedArt.clear();let e=this.mapColumns(t);if(e){let i=[];for(let d of t){let p=yield this.importArt(d,e);!!p.name&&i.push(p)}i.sort((d,p)=>d.name>p.name?1:-1);let o=yield this.api.art({cached:!1}),m=new Map,f=new Map;for(let d of o)m.set(d.name.toLowerCase(),d),d.externalId&&f.set(d.externalId.toLowerCase(),d);let v=new Map;v.set("existing",[]),v.set("new",[]),v.set("updated",[]);for(let d of i){let p=m.get(d.name.toLowerCase());!p&&d.externalId&&(p=f.get(d.externalId.toLowerCase()));let w=st(d,p),ct=w==="updated"?lt(d,p):void 0;p!=null&&p.id&&this.artWithIds.set(d.name.toLowerCase(),p.id);let mt={status:w,art:d,changedFields:ct};v.get(w).push(mt),this.art.push(d)}this.groupedArt=v,this.title=`Import ${this.art.length} art items`}})}import(){return h(this,null,function*(){this.busy=!0,this.title="Importing...";let n=0,t=0,e=this.art.length;for(;this.art.length>0;){let i;try{if(t++,i=this.art.pop(),i){let o=i.imageUrl;i.imageUrl=void 0;let m=this.artWithIds.get(i.name.toLowerCase());m&&(i.id=m),this.importing=i.name,this.progress=t/e;let f=yield this.api.addArt(i);if(n++,o&&f.id){i.id=f.id;try{yield this.importImage(o,i)}catch{console.error(`Unable to import image for art ${i.name}: ${o}`)}}}}catch{console.error(`Failed to import ${i==null?void 0:i.name}: ${i==null?void 0:i.description}`)}}this.api.sendMessage(`Imported ${n} of ${t} art items.`),this.busy=!1,this.api.clearCache(),this.location.back()})}toUrl(n){let t=!1,e="";for(let i of n)if(i=="(")t=!0;else if(i==")")if(t=!1,e.length<3)e="";else return e;else t&&(e+=i);return e}importImage(n,t){return h(this,null,function*(){let e=this.toUrl(n),o=yield(yield fetch(e)).blob(),m=yield it(o,{quality:75,width:300});this.url=URL.createObjectURL(m),t.imageUrl=yield this.api.setImage(m,t.id),yield this.api.addArt(t)})}mapColumns(n){if(n.length==0)return;let t=n[0],e={pin:"",name:"",category:"",id:void 0,art_type:"Art"};for(let i of Object.keys(t)){let o=i.toLowerCase();o.includes("name")&&!e.name&&!o.includes("artist name")&&(e.name=i),o=="title"&&!e.name&&(e.name=i),o.includes("art project")&&!e.name&&(e.name=i),o.includes("description")&&(e.description=i),o.includes("type")&&(e.art_type=i),(o.includes("web")||o.includes("url"))&&(e.url=i),o.includes("image")&&(e.image=i),o.includes("logo")&&(e.logo=i),o.includes("artist")&&(e.artist=i),o.includes("email")&&(e.contact_email=i),(o.includes("#")||o=="id")&&(e.externalId=i)}return console.log("map",e),e}importArt(n,t){return h(this,null,function*(){let e=yield this.api.getArt(void 0);e.name=n[t.name],t.description?e.description=n[t.description]:e.description=`Details on ${e.name} coming soon...`,t.externalId&&(e.externalId=n[t.externalId]),t.artist&&(e.artist=n[t.artist]),t.url&&(e.url=n[t.url]),t.art_type&&(e.art_type=n[t.art_type]),t.contact_email&&(e.contact_email=n[t.contact_email]);let i=t.image,o=t.logo;return i&&(e.imageUrl=n[i]),o&&this.isBlank(e.imageUrl)&&(e.imageUrl=n[o]),e})}isBlank(n){return!n||n.trim()==""}};I.\u0275fac=function(t){return new(t||I)},I.\u0275cmp=V({type:I,selectors:[["app-import-art"]],viewQuery:function(t,e){if(t&1&&R(pt,7),t&2){let i;L(i=$())&&(e.fileUpload=i.first)}},inputs:{vanity:[1,"vanity"]},decls:14,vars:5,consts:[["fileUpload",""],["color","primary"],["slot","start"],["routerLink","../"],["slot","end",3,"hidden"],[3,"click","disabled"],[3,"fullscreen"],[1,"border"],["type","file",1,"file-input",3,"change"],[3,"value"],[1,"ion-text-center","vcenter"],[2,"border-radius","2rem",3,"src"],[1,"ion-text-center"],[3,"click"],[1,"art-header"],["color","success"],["color","warning"],[1,"changed-fields"],["color","medium"]],template:function(t,e){if(t&1){let i=k();s(0,"ion-header")(1,"ion-toolbar",1)(2,"ion-buttons",2),C(3,"ion-back-button"),l(),s(4,"ion-title",3),c(5),l(),s(6,"ion-buttons",4)(7,"ion-button",5),U("click",function(){return b(i),S(e.import())}),c(8,"Import"),l()()()(),s(9,"ion-content",6),_(10,gt,6,3)(11,vt,8,3,"div",7),s(12,"input",8,0),U("change",function(m){return b(i),S(e.onFileSelected(m))}),l()()}t&2&&(a(5),g(e.title),a(),A("hidden",e.art.length===0),a(),A("disabled",e.busy),a(2),A("fullscreen",!0),a(),x(e.busy?10:11))},dependencies:[X,Y,Q,K,J,H,D,W,z,q,Z,tt,j,nt,G,N],styles:[".art-header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:.75rem;margin-bottom:.25rem}.art-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;flex:1}.changed-fields[_ngcontent-%COMP%]{color:#ff9500;font-size:.875rem;margin-top:.5rem;font-weight:500}"]});var dt=I;export{dt as ImportArtPage};
