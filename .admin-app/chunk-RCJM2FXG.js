import{a as J}from"./chunk-QTBNLBDF.js";import{a as H}from"./chunk-KCPLCCSF.js";import{a as G}from"./chunk-5EUBO754.js";import{I as z}from"./chunk-CXIDEVKY.js";import"./chunk-PFLI22GG.js";import{$ as k,Aa as g,D as x,G as a,O as w,Ra as T,Rb as R,W as b,Wa as V,X as C,Yb as B,Zb as F,_ as S,aa as p,ba as o,ca as c,da as u,ec as L,ia as A,ka as _,kc as O,lc as M,ma as v,mc as D,nc as Q,p as I,pc as j,qa as U,ra as P,s as h,sa as E,t as y,uc as N,vc as q,wc as W,yb as $,za as d}from"./chunk-GPCT4GNB.js";import"./chunk-JORYF43P.js";import"./chunk-7KGURMOZ.js";import"./chunk-UT2PGJWE.js";import"./chunk-6Y2ASLSF.js";import"./chunk-XRJ4SE6F.js";import"./chunk-LIBYTRNP.js";import"./chunk-3MK77LPM.js";import"./chunk-4U6PRYVA.js";import"./chunk-CZ4AHVKD.js";import"./chunk-Z4V4M3ZT.js";import"./chunk-LLZYEWEK.js";import"./chunk-Z2GS73PT.js";import"./chunk-LF5XB4YN.js";import{h as m}from"./chunk-LNJ3S2LQ.js";var Y=["fileUpload"],Z=(s,n)=>n.name;function ee(s,n){if(s&1&&(u(0,"ion-progress-bar",9),o(1,"ion-text"),d(2),c(),u(3,"app-spinner"),o(4,"div",10),u(5,"img",11),c()),s&2){let e=v();p("value",e.progress),a(2),g(e.importing),a(3),p("src",e.url,x)}}function te(s,n){if(s&1){let e=A();o(0,"div",12)(1,"ion-button",13),_("click",function(){h(e);let i=v(2);return y(i.doImport())}),d(2,"Import from CSV"),c()()}}function ie(s,n){if(s&1&&(o(0,"ion-item")(1,"ion-label")(2,"h3"),d(3),c(),o(4,"p"),d(5),c()()()),s&2){let e=n.$implicit;a(3),g(e.name),a(2),g(e.description)}}function ne(s,n){if(s&1&&(o(0,"div",7),b(1,te,3,0,"div",12),o(2,"ion-list"),S(3,ie,6,2,"ion-item",null,Z),c()()),s&2){let e=v();a(),C(e.isSafari&&e.art.length===0?1:-1),a(2),k(e.art)}}var f=class f{constructor(){this.api=I(z);this.location=I(V);this.vanity=T("");this.isAdmin=!1;this.busy=!1;this.art=[];this.title="Import Art";this.importing="";this.progress=0;this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);this.url=""}ngOnInit(){this.isAdmin=this.api.lastRoleResponse=="festival",this.isAdmin&&this.fileUpload.nativeElement.click()}doImport(){this.fileUpload.nativeElement.click()}onFileSelected(n){return m(this,null,function*(){let e=n.target.files[0];if(!e)return;let t=new FileReader;t.onload=i=>m(this,null,function*(){var l;let r=(l=i.target)==null?void 0:l.result;yield this.parseCSV(r);try{this.fileUpload.nativeElement.target&&(this.fileUpload.nativeElement.target.value="")}catch(X){console.info(X)}}),t.readAsText(e)})}parseCSV(n){return m(this,null,function*(){let e=J(n);console.info(e),this.art=[];let t=this.mapColumns(e);if(t){for(let i of e){let r=yield this.importArt(i,t);!!r.name&&this.art.push(r)}this.art.length==0&&this.api.sendMessage("Check the CSV file for missing columns."),this.art=this.art.sort((i,r)=>i.name>r.name?1:-1),this.title=`Import ${this.art.length} art items`}})}import(){return m(this,null,function*(){this.busy=!0,this.title="Importing...";let n=0,e=0,t=this.art.length;for(;this.art.length>0;){let i;try{if(e++,i=this.art.pop(),i){let r=i.imageUrl;i.imageUrl=void 0,this.importing=i.name,this.progress=e/t;let l=yield this.api.addArt(i);if(n++,r&&l.id){i.id=l.id;try{yield this.importImage(r,i)}catch{console.error(`Unable to import image for art ${i.name}: ${r}`)}}}}catch{console.error(`Failed to import ${i==null?void 0:i.name}: ${i==null?void 0:i.description}`)}}this.api.sendMessage(`Imported ${n} of ${e} art items.`),this.busy=!1,this.api.clearCache(),this.location.back()})}toUrl(n){let e=!1,t="";for(let i of n)if(i=="(")e=!0;else if(i==")")if(e=!1,t.length<3)t="";else return t;else e&&(t+=i);return t}importImage(n,e){return m(this,null,function*(){let t=this.toUrl(n),r=yield(yield fetch(t)).blob(),l=yield H(r,{quality:75,width:300});this.url=URL.createObjectURL(l),e.imageUrl=yield this.api.setImage(l,e.id),yield this.api.addArt(e)})}mapColumns(n){if(n.length==0)return;let e=n[0],t={pin:"",name:"",category:"",id:void 0,art_type:"Art"};for(let i of Object.keys(e)){let r=i.toLowerCase();r.includes("name")&&!t.name&&!r.includes("artist name")&&(t.name=i),r=="title"&&!t.name&&(t.name=i),r.includes("art project")&&!t.name&&(t.name=i),r.includes("description")&&(t.description=i),r.includes("type")&&(t.art_type=i),(r.includes("web")||r.includes("url"))&&(t.url=i),r.includes("image")&&(t.image=i),r.includes("logo")&&(t.logo=i),r.includes("artist")&&(t.artist=i),r.includes("email")&&(t.contact_email=i),(r.includes("#")||r=="id")&&(t.externalId=i)}return console.log("map",t),t}importArt(n,e){return m(this,null,function*(){let t=yield this.api.getArt(void 0);t.name=n[e.name],e.description?t.description=n[e.description]:t.description=`Details on ${t.name} coming soon...`,e.externalId&&(t.externalId=n[e.externalId]),e.artist&&(t.artist=n[e.artist]),e.url&&(t.url=n[e.url]),e.art_type&&(t.art_type=n[e.art_type]),e.contact_email&&(t.contact_email=n[e.contact_email]);let i=e.image,r=e.logo;return i&&(t.imageUrl=n[i]),r&&this.isBlank(t.imageUrl)&&(t.imageUrl=n[r]),t})}isBlank(n){return!n||n.trim()==""}};f.\u0275fac=function(e){return new(e||f)},f.\u0275cmp=w({type:f,selectors:[["app-import-art"]],viewQuery:function(e,t){if(e&1&&U(Y,7),e&2){let i;P(i=E())&&(t.fileUpload=i.first)}},inputs:{vanity:[1,"vanity"]},decls:14,vars:5,consts:[["fileUpload",""],["color","primary"],["slot","start"],["routerLink","../"],["slot","end",3,"hidden"],[3,"click","disabled"],[3,"fullscreen"],[1,"border"],["type","file",1,"file-input",3,"change"],[3,"value"],[1,"ion-text-center","vcenter"],[2,"border-radius","2rem",3,"src"],[1,"ion-text-center"],[3,"click"]],template:function(e,t){if(e&1){let i=A();o(0,"ion-header")(1,"ion-toolbar",1)(2,"ion-buttons",2),u(3,"ion-back-button"),c(),o(4,"ion-title",3),d(5),c(),o(6,"ion-buttons",4)(7,"ion-button",5),_("click",function(){return h(i),y(t.import())}),d(8,"Import"),c()()()(),o(9,"ion-content",6),b(10,ee,6,3)(11,ne,5,1,"div",7),o(12,"input",8,0),_("change",function(l){return h(i),y(t.onFileSelected(l))}),c()()}e&2&&(a(5),g(t.title),a(),p("hidden",t.art.length===0),a(),p("disabled",t.busy),a(2),p("fullscreen",!0),a(),C(t.busy?10:11))},dependencies:[j,N,B,Q,D,M,R,F,L,O,q,W,$,G],encapsulation:2});var K=f;export{K as ImportArtPage};
