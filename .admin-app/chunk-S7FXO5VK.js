import{a as z}from"./chunk-GPVDUW6Q.js";import{a as ye}from"./chunk-5B2MUMUK.js";import{a as F}from"./chunk-OZ2IKH4J.js";import"./chunk-ZHFJF7NS.js";import"./chunk-A5RC3O7B.js";import"./chunk-CVA27SDO.js";import"./chunk-U5OWWBBZ.js";import"./chunk-HC6MZPB3.js";import"./chunk-YMI2B6JE.js";import"./chunk-L4IPHJNS.js";import"./chunk-NPRM7GGH.js";import"./chunk-SFJBRZ2Y.js";import"./chunk-I5V6RRU4.js";import"./chunk-2EOHHFOF.js";import"./chunk-JXIEZMHN.js";import"./chunk-ZMJ3RQA5.js";import"./chunk-MCRJI3T3.js";import"./chunk-QDGYTOUC.js";import"./chunk-VLNXCBKY.js";import"./chunk-MM5QLNJM.js";import"./chunk-3573TPBU.js";import{K as L,g as he}from"./chunk-5GFD3MFK.js";import"./chunk-PFLI22GG.js";import{$ as Q,Aa as r,Ba as S,Bb as ee,C as R,Ca as $,Cc as de,Da as T,Db as te,Dc as me,Ec as ge,Fa as j,Fc as pe,Ga as A,H as l,Ha as O,Nc as ue,P as I,Ra as H,Sa as G,Tc as fe,Ua as P,Wb as ie,X as x,Y as M,Za as J,aa as U,ba as _,ca as o,cc as k,da as s,db as K,dc as ne,ea as y,ec as E,fc as D,gb as X,gc as oe,ic as se,ja as w,la as h,lc as ae,na as c,p as u,rc as re,s as g,sc as V,t as p,tb as Y,uc as le,vc as N,w as f,wb as Z,xc as ce}from"./chunk-FDEJMFAU.js";import"./chunk-JORYF43P.js";import"./chunk-7KGURMOZ.js";import"./chunk-UT2PGJWE.js";import"./chunk-6Y2ASLSF.js";import"./chunk-XRJ4SE6F.js";import"./chunk-LIBYTRNP.js";import"./chunk-3MK77LPM.js";import"./chunk-4U6PRYVA.js";import"./chunk-CZ4AHVKD.js";import"./chunk-Z4V4M3ZT.js";import"./chunk-LLZYEWEK.js";import"./chunk-Z2GS73PT.js";import"./chunk-LF5XB4YN.js";import{h as m}from"./chunk-LNJ3S2LQ.js";var ve=(a,t)=>t.date;function xe(a,t){a&1&&(o(0,"ion-card")(1,"ion-card-content",3),y(2,"ion-spinner",4),o(3,"ion-text")(4,"p"),r(5,"Loading message history..."),s()()()())}function Me(a,t){if(a&1){let e=w();o(0,"ion-card",1)(1,"ion-card-content",5)(2,"ion-text")(3,"h3"),r(4,"Error Loading History"),s(),o(5,"p"),r(6),s()(),o(7,"ion-button",6),h("click",function(){g(e);let i=c(2);return p(i.loadHistory())}),r(8," Retry "),s()()()}if(a&2){let e=c(2);l(6),S(e.error())}}function we(a,t){a&1&&(o(0,"ion-card")(1,"ion-card-content",7)(2,"ion-text")(3,"h3"),r(4,"No Message History"),s(),o(5,"p"),r(6," No messages have been sent yet. Once you send your first message, it will appear here for future reference. "),s()()()())}function Ie(a,t){if(a&1){let e=w();o(0,"ion-item")(1,"ion-label")(2,"p"),r(3),s(),o(4,"b"),r(5),s(),y(6,"br"),o(7,"p"),r(8),s()(),o(9,"ion-note")(10,"ion-button",8),h("click",function(){let i=g(e).$implicit,d=c(3);return p(d.recall(i))}),r(11,"Recall"),s()()()}if(a&2){let e=t.$implicit,n=c(3);l(3),T("",n.formatDate(e.date)," from ",e.from.name),l(2),S(e.subject),l(3),S(e.html)}}function Se(a,t){if(a&1&&(o(0,"div",2)(1,"ion-card")(2,"ion-card-header")(3,"ion-card-title"),r(4,"Message History"),s()(),o(5,"ion-card-content")(6,"ion-list"),Q(7,Ie,12,4,"ion-item",null,ve),s()()()()),a&2){let e=c(2);l(7),U(e.sortedMessages())}}function Te(a,t){if(a&1&&(o(0,"div",0),x(1,xe,6,0,"ion-card")(2,Me,9,1,"ion-card",1)(3,we,7,0,"ion-card")(4,Se,9,0,"div",2),s()),a&2){let e=c();l(),M(e.loading()?1:e.error()?2:e.isEmpty()?3:4)}}var C=class C{constructor(){this.visible=P(!1);this.messages=f([]);this.loading=f(!1);this.error=f(null);this.hasMessages=H(()=>this.messages().length>0);this.isEmpty=H(()=>!this.loading()&&this.messages().length===0);this.sortedMessages=H(()=>[...this.messages()].sort((t,e)=>new Date(e.date).getTime()-new Date(t.date).getTime()));this.api=u(L);this.sanitizer=u(X);this.alertController=u(z);G(()=>{this.visible()&&(console.log("Message history component became visible, loading history..."),this.loadHistory())})}loadHistory(){return m(this,null,function*(){try{this.loading.set(!0),this.error.set(null),console.log("Loading message history...");let t=yield this.api.getMessageHistory();console.log("Message history loaded:",t.length,"items"),this.messages.set(t)}catch(t){console.error("Failed to load message history:",t);let e="Unable to load message history. Please try again.";if(t instanceof Error){let n=t.message.toLowerCase();n.includes("network")||n.includes("fetch")?e="Unable to load message history. Check your connection.":n.includes("unauthorized")||n.includes("authentication")?e="Authentication required. Please log in again.":n.includes("server")||n.includes("500")?e="Server error occurred. Please try again later.":(n.includes("invalid")||n.includes("parse"))&&(e="Invalid message data received. Please contact support.")}this.error.set(e)}finally{this.loading.set(!1)}})}formatDate(t){try{return new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return t}}recall(t){return m(this,null,function*(){(yield F(this.alertController,"This message will only be recalled from displaying in the messages tab of the dust app. Notifications for the message already went out.","Recall"))&&(yield this.performRecall(t))})}performRecall(t){return m(this,null,function*(){try{let n=(yield this.api.getMessageHistory()).filter(i=>!(i.subject===t.subject&&i.date===t.date&&i.from.name===t.from.name));yield this.api.setMessageHistory(n),this.messages.set(n),console.log("Message recalled successfully:",t.subject)}catch(e){console.error("Failed to recall message:",e),this.error.set("Failed to recall message. Please try again.")}})}sanitizeHtml(t){let e=this.sanitizer.sanitize(R.HTML,t)||"";return this.sanitizer.bypassSecurityTrustHtml(e)}};C.\u0275fac=function(e){return new(e||C)},C.\u0275cmp=I({type:C,selectors:[["app-message-history"]],inputs:{visible:[1,"visible"]},decls:1,vars:1,consts:[[1,"message-history-container"],["color","danger"],[1,"messages-list"],[1,"loading-content"],["name","crescent"],[1,"error-content"],["fill","outline",3,"click"],[1,"empty-content"],["color","secondary",3,"click"]],template:function(e,n){e&1&&x(0,Te,5,1,"div",0),e&2&&M(n.visible()?0:-1)},dependencies:[ce,le,V,N,K,E,D,oe,se,de,me,k],styles:["ion-note[_ngcontent-%COMP%]{margin-top:2rem}"]});var B=C;function He(a,t){if(a&1){let e=w();o(0,"div",6)(1,"ion-card",8)(2,"ion-card-content",8)(3,"ion-list",9)(4,"ion-item")(5,"ion-input",10),O("ngModelChange",function(i){g(e);let d=c();return A(d.message.title,i)||(d.message.title=i),p(i)}),s()(),o(6,"ion-item")(7,"ion-textarea",11),O("ngModelChange",function(i){g(e);let d=c();return A(d.message.description,i)||(d.message.description=i),p(i)}),s()()(),o(8,"div",12),h("click",function(){g(e);let i=c();return p(i.processQueue())}),r(9),s(),o(10,"div",13)(11,"ion-button",14),h("click",function(){g(e);let i=c();return p(i.toggleHistory())}),r(12),s(),o(13,"ion-button",15),h("click",function(){g(e);let i=c();return p(i.send())}),r(14,"Send"),s()()()(),y(15,"app-message-history",16),s()}if(a&2){let e=c();l(5),j("ngModel",e.message.title),l(2),_("counterFormatter",e.customCounterFormatter)("spellcheck",!0)("rows",6)("maxlength",178)("autoGrow",!0),j("ngModel",e.message.description),l(2),T(" This will send a notification to ",e.pushInformation.deviceCount," users who have accepted receiving notifications for ",e.festivalTitle," in the dust app. "),l(3),$(" ",e.historyVisible()?"Hide History":"History"," "),l(),_("disabled",e.busy()),l(2),_("visible",e.historyVisible())}}function Pe(a,t){if(a&1&&y(0,"app-spinner",7),a&2){let e=c();_("title",e.spinnerTitle())}}var b=class b{constructor(){this.message={title:"",description:""};this.pushInformation={deviceCount:0};this.festivalTitle="";this.busy=f(!1);this.spinnerTitle=f("Sending message...");this.historyVisible=f(!1);this.vanity=P();this.api=u(L);this.location=u(J);this.alert=u(z)}ngOnInit(){return m(this,null,function*(){yield this.api.setFestivalByVanity(this.vanity(),!0),this.festivalTitle=this.api.festivalTitle()})}ionViewWillEnter(){return m(this,null,function*(){let t=yield this.api.getPushInformation();this.pushInformation=t.data})}customCounterFormatter(t,e){return`${e-t} characters remaining`}toggleHistory(){let t=!this.historyVisible();console.log("Toggling message history visibility from",this.historyVisible(),"to",t),this.historyVisible.set(t)}send(){return m(this,null,function*(){var t,e;try{if(this.message.title.length==0){this.api.sendMessage("Title is required");return}if(this.message.description.length==0){this.api.sendMessage("Description is required");return}if(!(yield F(this.alert,`Send message "${this.message.title}" to ${this.pushInformation.deviceCount} users ?`,"Send")))return;this.busy.set(!0),yield this.api.sendPushMessage({title:this.message.title,description:this.message.description});let i=this.pushInformation.deviceCount,d=!0,W=!0,q=0;for(;W;)try{q++,this.spinnerTitle.set(`Sending messages (${i} remaining)...`);let v=yield this.api.processMessageQueue();console.log("Message batch processed:",v.data),i=((t=v.data)==null?void 0:t.remainingTokens)||0,i>0&&(yield he(500)),(((e=v.data)==null?void 0:e.totalAttempted)==0||i==0)&&(W=!1),q>500&&(W=!1)}catch(v){console.error("Error processing message queue:",v),this.api.sendMessage("Error processing message queue. Please try again later."),d=!1;break}this.location.back(),d&&this.api.sendMessage("Message Sent")}finally{this.busy.set(!1)}})}processQueue(){return m(this,null,function*(){let t=yield this.api.processMessageQueue();console.log("Message batch processed:",t.data)})}};b.\u0275fac=function(e){return new(e||b)},b.\u0275cmp=I({type:b,selectors:[["app-message"]],inputs:{vanity:[1,"vanity"]},decls:12,vars:2,consts:[["color","primary"],["slot","start"],["routerLink","../"],["slot","end"],[3,"click"],[3,"fullscreen"],[1,"border"],[3,"title"],[1,"form"],["lines","none"],["label","Title","labelPlacement","stacked","placeholder","Title of the message",3,"ngModelChange","ngModel"],["labelPlacement","stacked","label","Description","placeholder","Description of the message",3,"ngModelChange","counterFormatter","spellcheck","rows","maxlength","autoGrow","ngModel"],[1,"padded",3,"click"],[1,"center"],["color","secondary",3,"click"],[3,"click","disabled"],[3,"visible"]],template:function(e,n){e&1&&(o(0,"ion-header")(1,"ion-toolbar",0)(2,"ion-buttons",1),y(3,"ion-back-button"),s(),o(4,"ion-title",2),r(5,"Notify"),s(),o(6,"ion-buttons",3)(7,"ion-button",4),h("click",function(){return n.send()}),r(8," Send "),s()()()(),o(9,"ion-content",5),x(10,He,16,12,"div",6)(11,Pe,1,1,"app-spinner",7),s()),e&2&&(l(9),_("fullscreen",!0),l(),M(n.busy()?11:10))},dependencies:[V,N,D,E,k,ie,ue,ne,ae,re,fe,ge,pe,te,Y,ee,Z,ye,B],styles:[".padded[_ngcontent-%COMP%]{padding-left:25%;padding-right:25%;text-align:center}"]});var _e=b;export{_e as MessagePage};
